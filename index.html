<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">
    <meta name="darkreader-lock">
    <title>Icebreaker Bingo</title>
    <meta name="description" content="A fun icebreaker game — check off the squares that match you and see how many bingos you can get!">

    <!-- Open Graph (Facebook, LinkedIn, etc.) -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://icebreakerbingo.com">
    <meta property="og:title" content="Icebreaker Bingo">
    <meta property="og:description" content="How many squares can you check off? Play Icebreaker Bingo and find out!">
    <meta property="og:image" content="https://icebreakerbingo.com/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter / X Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Icebreaker Bingo">
    <meta name="twitter:description" content="How many squares can you check off? Play Icebreaker Bingo and find out!">
    <meta name="twitter:image" content="https://icebreakerbingo.com/og-image.png">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://icebreakerbingo.com/">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Icebreaker Bingo",
        "url": "https://icebreakerbingo.com",
        "description": "A fun icebreaker game — check off the squares that match you and see how many bingos you can get!",
        "applicationCategory": "GameApplication",
        "genre": "Casual",
        "operatingSystem": "Any",
        "browserRequirements": "Requires a modern web browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "image": "https://icebreakerbingo.com/og-image.png",
        "screenshot": "https://icebreakerbingo.com/og-image.png",
        "author": {
            "@type": "Organization",
            "name": "Icebreaker Bingo"
        }
    }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'DSEG7';
            src: url('https://cdn.jsdelivr.net/npm/dseg@0.46/fonts/DSEG7-Classic/DSEG7Classic-Bold.woff2') format('woff2'),
                 url('https://cdn.jsdelivr.net/npm/dseg@0.46/fonts/DSEG7-Classic/DSEG7Classic-Bold.woff') format('woff');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }
    </style>
    <style>
        :root {
            /* Arctic palette */
            --bg-deep: #091832;
            --bg-mid: #0d2348;
            --aurora-cyan: rgba(56, 189, 248, 0.22);
            --aurora-purple: rgba(139, 92, 246, 0.18);
            --aurora-teal: rgba(45, 212, 191, 0.12);
            --aurora-accent1: rgba(56, 189, 248, 0.10);
            --aurora-accent2: rgba(139, 92, 246, 0.10);

            /* Ice tile colors */
            --ice-light: #d4e6f6;
            --ice-mid: #b3ced8;
            --ice-edge: #7ba6c9;
            --ice-border: rgba(255, 255, 255, 0.45);
            --ice-text: #152540;

            /* Tile gradient */
            --tile-from: #dae9f6;
            --tile-mid: #bdd4e8;
            --tile-to: #a8c4dc;

            /* Checked state */
            --checked-from: #14b8a6;
            --checked-mid: #8b5cf6;
            --checked-to: #6d28d9;
            --checked-span-from: #0f766e;
            --checked-span-to: #5b21b6;
            --checked-edge: #134e4a;
            --cracked-glow: rgba(45, 212, 191, 0.4);

            /* Center cell */
            --center-from: #fbbf24;
            --center-mid: #d97706;
            --center-to: #b45309;
            --center-edge: #92400e;
            --center-glow: rgba(251, 191, 36, 0.35);

            /* Gold (legacy alias) */
            --gold: #d97706;
            --gold-glow: rgba(251, 191, 36, 0.35);

            /* Title glow */
            --title-glow: rgba(56, 189, 248, 0.28);
            --title-glow-wide: rgba(56, 189, 248, 0.10);

            /* Board frame glow */
            --frame-glow: rgba(56, 189, 248, 0.06);

            /* UI surfaces */
            --frost-surface: rgba(255, 255, 255, 0.07);
            --frost-border: rgba(255, 255, 255, 0.10);
            --text-light: #e2e8f0;
            --text-bright: #ffffff;
            --text-dim: #94a3b8;
            --text-muted: #64748b;
            --focus-ring: #38bdf8;

            /* Shared */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --content-max: 560px;
            --sidebar-width: 300px;
        }

        /* ─── Work Theme: Slate/charcoal + amber accents ─── */
        body[data-visual-theme="work"] {
            --bg-deep: #141428;
            --bg-mid: #1c1c3a;
            --aurora-cyan: rgba(251, 191, 36, 0.20);
            --aurora-purple: rgba(168, 162, 200, 0.16);
            --aurora-teal: rgba(251, 146, 60, 0.14);
            --aurora-accent1: rgba(251, 191, 36, 0.10);
            --aurora-accent2: rgba(168, 162, 200, 0.08);
            --ice-light: #e2e4ea;
            --ice-mid: #c8cbd4;
            --ice-edge: #8891a0;
            --ice-border: rgba(255, 255, 255, 0.35);
            --ice-text: #1e293b;
            --tile-from: #e2e4ea;
            --tile-mid: #cdd1da;
            --tile-to: #b8bdc8;
            --checked-from: #f59e0b;
            --checked-mid: #3b82f6;
            --checked-to: #1e3a8a;
            --checked-span-from: #b45309;
            --checked-span-to: #1e40af;
            --checked-edge: #78350f;
            --cracked-glow: rgba(251, 191, 36, 0.35);
            --center-from: #f59e0b;
            --center-mid: #d97706;
            --center-to: #92400e;
            --center-edge: #78350f;
            --center-glow: rgba(245, 158, 11, 0.35);
            --title-glow: rgba(251, 191, 36, 0.28);
            --title-glow-wide: rgba(251, 191, 36, 0.10);
            --frame-glow: rgba(251, 191, 36, 0.06);
            --focus-ring: #f59e0b;
        }

        /* ─── Friends Theme: Vibrant purple/magenta ─── */
        body[data-visual-theme="friends"] {
            --bg-deep: #1a1d1e;
            --bg-mid: #2a2d2f;
            --aurora-cyan: rgba(168, 162, 148, 0.22);
            --aurora-purple: rgba(120, 140, 120, 0.20);
            --aurora-teal: rgba(200, 170, 120, 0.16);
            --aurora-accent1: rgba(168, 162, 148, 0.10);
            --aurora-accent2: rgba(140, 160, 140, 0.10);
            --ice-light: #eae6e0;
            --ice-mid: #d5cfc6;
            --ice-edge: #a09888;
            --ice-border: rgba(255, 255, 255, 0.35);
            --ice-text: #2a2520;
            --tile-from: #eae6e0;
            --tile-mid: #ddd8cf;
            --tile-to: #cdc5b8;
            --checked-from: #78886a;
            --checked-mid: #5c7a5c;
            --checked-to: #4a6848;
            --checked-span-from: #5a6e4e;
            --checked-span-to: #3d5a3a;
            --checked-edge: #344830;
            --cracked-glow: rgba(120, 136, 106, 0.4);
            --center-from: #c8a86a;
            --center-mid: #b8963c;
            --center-to: #8a7030;
            --center-edge: #6e5828;
            --center-glow: rgba(200, 168, 106, 0.4);
            --title-glow: rgba(168, 162, 148, 0.28);
            --title-glow-wide: rgba(168, 162, 148, 0.10);
            --frame-glow: rgba(217, 70, 239, 0.06);
            --focus-ring: #d946ef;
        }

        /* ─── Family Theme: Cheerful primary colors ─── */
        body[data-visual-theme="family"] {
            --bg-deep: #0a1838;
            --bg-mid: #10224e;
            --aurora-cyan: rgba(59, 130, 246, 0.24);
            --aurora-purple: rgba(251, 191, 36, 0.20);
            --aurora-teal: rgba(34, 197, 94, 0.14);
            --aurora-accent1: rgba(59, 130, 246, 0.12);
            --aurora-accent2: rgba(251, 191, 36, 0.10);
            --ice-light: #e0ecf8;
            --ice-mid: #c8d9ee;
            --ice-edge: #7da3cc;
            --ice-border: rgba(255, 255, 255, 0.40);
            --ice-text: #1a2744;
            --tile-from: #e4edf8;
            --tile-mid: #d2e0f0;
            --tile-to: #bdd0e6;
            --checked-from: #3b82f6;
            --checked-mid: #eab308;
            --checked-to: #16a34a;
            --checked-span-from: #1d4ed8;
            --checked-span-to: #15803d;
            --checked-edge: #1e3a5f;
            --cracked-glow: rgba(59, 130, 246, 0.35);
            --center-from: #fbbf24;
            --center-mid: #eab308;
            --center-to: #a16207;
            --center-edge: #854d0e;
            --center-glow: rgba(234, 179, 8, 0.4);
            --title-glow: rgba(59, 130, 246, 0.28);
            --title-glow-wide: rgba(59, 130, 246, 0.10);
            --frame-glow: rgba(59, 130, 246, 0.06);
            --focus-ring: #3b82f6;
        }

        /* ─── First Date Theme: Soft rose/blush ─── */
        body[data-visual-theme="dating"] {
            --bg-deep: #30082a;
            --bg-mid: #461040;
            --aurora-cyan: rgba(244, 114, 182, 0.24);
            --aurora-purple: rgba(232, 121, 249, 0.18);
            --aurora-teal: rgba(251, 191, 36, 0.12);
            --aurora-accent1: rgba(244, 114, 182, 0.12);
            --aurora-accent2: rgba(232, 121, 249, 0.10);
            --ice-light: #f5e0ea;
            --ice-mid: #eacbd8;
            --ice-edge: #c48da6;
            --ice-border: rgba(255, 255, 255, 0.38);
            --ice-text: #3b0820;
            --tile-from: #f5e0ea;
            --tile-mid: #eed2e0;
            --tile-to: #e4bfd2;
            --checked-from: #f472b6;
            --checked-mid: #c084fc;
            --checked-to: #7c3aed;
            --checked-span-from: #db2777;
            --checked-span-to: #6d28d9;
            --checked-edge: #9d174d;
            --cracked-glow: rgba(244, 114, 182, 0.4);
            --center-from: #fda4af;
            --center-mid: #f472b6;
            --center-to: #db2777;
            --center-edge: #9d174d;
            --center-glow: rgba(244, 114, 182, 0.4);
            --title-glow: rgba(244, 114, 182, 0.28);
            --title-glow-wide: rgba(244, 114, 182, 0.10);
            --frame-glow: rgba(244, 114, 182, 0.06);
            --focus-ring: #f472b6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            background: var(--bg-deep);
            background-image:
                radial-gradient(ellipse at 30% 10%, var(--aurora-cyan) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 20%, var(--aurora-purple) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, var(--aurora-teal) 0%, transparent 50%),
                radial-gradient(ellipse at 15% 90%, var(--aurora-accent1) 0%, transparent 40%),
                radial-gradient(ellipse at 85% 60%, var(--aurora-accent2) 0%, transparent 40%);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        /* ─── Skip Link (WCAG 2.4.1) ─── */
        .skip-link {
            position: absolute;
            top: -100%;
            left: 16px;
            z-index: 2000;
            background: var(--focus-ring);
            color: var(--bg-deep);
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 600;
            text-decoration: none;
            box-shadow: 0 4px 20px rgba(56, 189, 248, 0.4);
        }

        .skip-link:focus {
            top: 16px;
            outline: 3px solid var(--text-bright);
            outline-offset: 2px;
        }

        /* ─── Global Focus (WCAG 2.4.7) ─── */
        :focus-visible {
            outline: 3px solid var(--focus-ring);
            outline-offset: 2px;
        }

        /* ─── Toast Notification ─── */
        .share-toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(15, 23, 42, 0.92);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #e2e8f0;
            font-family: Inter, system-ui, sans-serif;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(148, 163, 184, 0.08);
            z-index: 10000;
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease;
            pointer-events: none;
        }
        .share-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .share-toast .toast-icon {
            font-size: 18px;
            flex-shrink: 0;
        }
        @media (prefers-reduced-motion: reduce) {
            .share-toast {
                transition: opacity 0.2s ease;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* ─── Share Panel Overlay ─── */
        .share-overlay {
            position: fixed;
            inset: 0;
            z-index: 9000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(2, 6, 18, 0.75);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .share-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .share-panel {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            padding: 32px 28px 28px;
            max-width: 440px;
            width: 90vw;
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(148, 163, 184, 0.06);
            transform: translateY(24px) scale(0.96);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
        }
        .share-overlay.active .share-panel {
            transform: translateY(0) scale(1);
        }

        .share-panel-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            line-height: 1;
        }
        .share-panel-close:hover {
            background: rgba(255, 255, 255, 0.12);
            color: var(--text-bright);
        }

        .share-panel-title {
            font-family: Fredoka, Inter, system-ui, sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-bright);
            text-align: center;
            margin: 0 0 6px;
        }

        .share-panel-hint {
            font-size: 0.82rem;
            color: var(--text-muted);
            text-align: center;
            margin: 0 0 24px;
            line-height: 1.4;
        }
        .share-panel-hint .hint-icon {
            color: #34d399;
        }
        .share-panel-hint .wave-char {
            display: inline-block;
            color: var(--text-muted);
        }
        .share-panel-hint.has-image .wave-char {
            animation: hintWave 6s ease-in-out infinite;
        }
        @keyframes hintWave {
            0%, 100% { color: var(--text-muted); transform: translateY(0); }
            8% { color: #34d399; transform: translateY(-3px); }
            16% { color: var(--text-muted); transform: translateY(0); }
        }

        /* Platform button grid */
        .share-platforms {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .platform-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 10px 10px;
            width: 68px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        .platform-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.18);
            transform: translateY(-2px);
        }
        .platform-btn:active {
            transform: translateY(0);
        }
        .platform-btn svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        .platform-btn .platform-label {
            font-family: Inter, system-ui, sans-serif;
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--text-muted);
            white-space: nowrap;
        }

        /* Brand hover colors */
        .platform-btn[data-platform="x"]:hover { border-color: #a8a8a8; box-shadow: 0 4px 16px rgba(168, 168, 168, 0.15); }
        .platform-btn[data-platform="threads"]:hover { border-color: #a8a8a8; box-shadow: 0 4px 16px rgba(168, 168, 168, 0.15); }
        .platform-btn[data-platform="facebook"]:hover { border-color: #1877F2; box-shadow: 0 4px 16px rgba(24, 119, 242, 0.2); }
        .platform-btn[data-platform="instagram"]:hover { border-color: #E1306C; box-shadow: 0 4px 16px rgba(225, 48, 108, 0.2); }
        .platform-btn[data-platform="whatsapp"]:hover { border-color: #25D366; box-shadow: 0 4px 16px rgba(37, 211, 102, 0.2); }
        .platform-btn[data-platform="linkedin"]:hover { border-color: #0A66C2; box-shadow: 0 4px 16px rgba(10, 102, 194, 0.2); }
        .platform-btn[data-platform="email"]:hover { border-color: #f59e0b; box-shadow: 0 4px 16px rgba(245, 158, 11, 0.15); }

        /* Secondary actions grid */
        .share-secondary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .share-secondary button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            font-family: Inter, system-ui, sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .share-secondary button#shareNativeBtn {
            grid-column: 1 / -1;
        }
        .share-secondary button:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: var(--text-bright);
        }
        .share-secondary button svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        /* ─── Paste Coach ─── */
        .paste-coach {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            background: rgba(2, 6, 23, 0.92);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.35s ease, visibility 0.35s ease;
        }
        .paste-coach.active {
            opacity: 1;
            visibility: visible;
        }
        .paste-coach-card {
            text-align: center;
            max-width: 360px;
            width: 100%;
            padding: 36px 32px 28px;
            /* Centered in the visible gap left of the popup (set via JS).
               Falls back to viewport-center when gap is too narrow. */
            margin-left: var(--coach-offset, auto);
            margin-right: var(--coach-mr, auto);
        }
        .paste-coach-platform {
            font-family: Inter, system-ui, sans-serif;
            font-size: 0.78rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin: 0 0 16px;
        }
        .paste-coach-keys {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 0 0 20px;
        }
        .paste-coach-key {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            height: 48px;
            padding: 0 14px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.06);
            color: var(--text-bright);
            font-family: Inter, system-ui, sans-serif;
            font-size: 1rem;
            font-weight: 600;
        }
        .paste-coach-key-plus {
            color: var(--text-muted);
            font-size: 1.1rem;
            font-weight: 400;
        }
        .paste-coach-msg {
            font-family: Inter, system-ui, sans-serif;
            font-size: 0.95rem;
            color: var(--text-light);
            line-height: 1.5;
            margin: 0 0 24px;
        }
        .paste-coach-msg strong {
            color: var(--text-bright);
        }
        /* Loading / instructions phase transitions */
        .paste-coach-loading {
            transition: opacity 0.4s ease;
        }
        .paste-coach-loading.fade-out {
            opacity: 0;
        }
        .paste-coach-instructions {
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .paste-coach-instructions.fade-in {
            opacity: 1;
        }
        /* Animated ellipsis */
        .animated-ellipsis::after {
            content: '';
            display: inline-block;
            width: 1.2em;
            text-align: left;
            animation: ellipsis 1.4s steps(4, end) infinite;
        }
        @keyframes ellipsis {
            0%  { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
        }
        .paste-coach-dismiss {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: var(--text-muted);
            font-family: Inter, system-ui, sans-serif;
            font-size: 0.78rem;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .paste-coach-dismiss:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
        }
        @media (prefers-reduced-motion: reduce) {
            .share-overlay { transition: opacity 0.15s ease, visibility 0.15s ease; }
            .share-panel { transition: none; transform: none; }
            .platform-btn { transition: none; }
            .platform-btn:hover { transform: none; }
            .paste-coach { transition: opacity 0.15s ease, visibility 0.15s ease; }
            .paste-coach-loading, .paste-coach-instructions { transition: none; }
            .animated-ellipsis::after { animation: none; content: '...'; }
        
        }

        /* ─── Decorative Snowflakes ─── */
        .snowflakes {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .snowflake {
            position: absolute;
            top: -6%;
            font-size: 1rem;
            animation: snowfall linear infinite, snowsway ease-in-out infinite;
            user-select: none;
            filter: blur(0px);
        }

        /* nth-child styles removed — particles are built dynamically by JS */

        @keyframes snowfall {
            0%   { transform: translateY(-5vh) rotate(0deg);   opacity: 0; }
            8%   { opacity: 1; }
            85%  { opacity: 1; }
            100% { transform: translateY(108vh) rotate(720deg); opacity: 0; }
        }

        @keyframes snowsway {
            0%, 100% { margin-left: 0; }
            25%      { margin-left: 30px; }
            75%      { margin-left: -30px; }
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0.4; text-shadow: 0 0 0 transparent; }
            50%      { opacity: 1;   text-shadow: 0 0 8px currentColor, 0 0 16px currentColor; }
        }

        /* ─── Top Leaderboard Ad ─── */
        .ad-leaderboard {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 8px 16px 0;
            position: relative;
            z-index: 1;
        }

        .ad-leaderboard .ad-slot {
            width: 728px;
            max-width: 100%;
            height: 90px;
        }

        /* ─── Page Layout ─── */
        .page-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 24px;
            width: 100%;
            max-width: 1200px;
            padding: 12px 16px 20px;
            position: relative;
            z-index: 1;
        }

        /* ─── Sidebar Ads ─── */
        .ad-sidebar {
            flex-shrink: 0;
            width: var(--sidebar-width);
            position: sticky;
            top: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .ad-sidebar .ad-slot {
            width: var(--sidebar-width);
            height: 250px;
        }

        /* ─── Ad Slot Base ─── */
        .ad-slot {
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
            font-size: 0.8rem;
        }

        /* ─── Main Content ─── */
        .main-content {
            flex: 1;
            max-width: var(--content-max);
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        /* ─── Header ─── */
        .header {
            text-align: center;
            padding-top: 4px;
        }

        .header h1 {
            font-family: 'Fredoka', 'Inter', sans-serif;
            font-size: 2.6rem;
            font-weight: 700;
            color: var(--text-bright);
            line-height: 1.1;
            text-shadow:
                0 0 16px var(--title-glow),
                0 0 40px var(--title-glow-wide),
                0 2px 0 rgba(0, 0, 0, 0.25);
            letter-spacing: -0.01em;
        }

        .header p {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-top: 6px;
            font-weight: 500;
        }

        /* ─── HUD Row ─── */
        .hud-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* ─── Scoreboard ─── */
        .stats-bar {
            display: inline-flex;
            align-items: center;
            gap: 0;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-md);
            padding: 0;
            box-shadow:
                inset 0 2px 6px rgba(0, 0, 0, 0.4),
                inset 0 0 1px rgba(0, 0, 0, 0.3);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 14px;
        }

        .stat-divider {
            width: 1px;
            height: 18px;
            background: rgba(255, 255, 255, 0.08);
            flex-shrink: 0;
        }

        .stat-label {
            font-size: 0.65rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.35);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .stat-value {
            font-family: 'DSEG7', 'Fredoka', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #38bdf8;
            line-height: 1;
            text-shadow: 0 0 8px rgba(56, 189, 248, 0.5), 0 0 20px rgba(56, 189, 248, 0.2);
            min-width: 1.4em;
            text-align: center;
        }

        /* ─── Reset Button (below board) ─── */
        .reset-btn {
            display: inline-flex;
            align-items: center;
            gap: 7px;
            font-family: 'Fredoka', 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.55rem 1.5rem;
            background: var(--frost-surface);
            border: 1px solid var(--frost-border);
            border-radius: 50px;
            color: var(--text-light);
            cursor: pointer;
            transition: all var(--transition);
            box-shadow:
                0 3px 0 rgba(255, 255, 255, 0.04),
                0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .reset-btn svg {
            width: 14px;
            height: 14px;
        }

        .reset-btn:hover {
            background: rgba(56, 189, 248, 0.12);
            border-color: rgba(56, 189, 248, 0.25);
            color: var(--text-bright);
            box-shadow:
                0 3px 0 rgba(255, 255, 255, 0.04),
                0 6px 18px rgba(0, 0, 0, 0.25);
            transform: translateY(-1px);
        }

        .reset-btn:active {
            transform: translateY(1px);
            box-shadow:
                0 1px 0 rgba(255, 255, 255, 0.04),
                0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .reset-btn:focus-visible {
            outline: 3px solid var(--focus-ring);
            outline-offset: 2px;
        }

        /* ─── Sound Toggle ─── */
        .sound-toggle {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px 5px 10px;
            border-radius: 100px;
            background: var(--frost-surface);
            border: 1px solid var(--frost-border);
            color: #fbbf24;
            cursor: pointer;
            transition: all var(--transition);
            font-family: 'Inter', sans-serif;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            border-color: rgba(251, 191, 36, 0.25);
            box-shadow:
                0 2px 12px rgba(0, 0, 0, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.05);
        }
        .sound-toggle:hover {
            background: rgba(251, 191, 36, 0.12);
            color: #fde68a;
            border-color: rgba(251, 191, 36, 0.4);
        }
        .sound-toggle.active {
            border-color: rgba(251, 191, 36, 0.4);
            color: #fde68a;
        }
        .sound-toggle svg { width: 16px; height: 16px; flex-shrink: 0; }
        .sound-toggle .icon-on { display: none; }
        .sound-toggle .icon-off { display: block; }
        .sound-toggle.active .icon-on { display: block; }
        .sound-toggle.active .icon-off { display: none; }
        .sound-toggle .sound-label-on { display: none; }
        .sound-toggle .sound-label-off { display: inline; }
        .sound-toggle.active .sound-label-on { display: inline; }
        .sound-toggle.active .sound-label-off { display: none; }

        /* Attention pulse on first load */
        .sound-toggle.hint-pulse {
            animation: soundHintPulse 2s ease-in-out 3;
        }
        @keyframes soundHintPulse {
            0%, 100% {
                box-shadow:
                    0 2px 12px rgba(0, 0, 0, 0.2),
                    inset 0 1px 1px rgba(255, 255, 255, 0.05);
            }
            50% {
                box-shadow:
                    0 2px 12px rgba(0, 0, 0, 0.2),
                    inset 0 1px 1px rgba(255, 255, 255, 0.05),
                    0 0 12px rgba(251, 191, 36, 0.4),
                    0 0 24px rgba(251, 191, 36, 0.18);
                border-color: rgba(251, 191, 36, 0.45);
            }
        }

        /* ─── Achievement Toast ─── */
        .achievement-toast {
            position: fixed;
            top: 18px;
            left: 50%;
            transform: translateX(-50%) translateY(-120px);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 22px 10px 16px;
            border-radius: 50px;
            background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
            border: 1px solid rgba(255,255,255,0.18);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            box-shadow:
                0 8px 32px rgba(0,0,0,0.35),
                0 0 20px var(--frame-glow);
            opacity: 0;
            pointer-events: none;
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease;
        }
        .achievement-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .achievement-toast .ach-icon {
            font-size: 1.3rem;
            line-height: 1;
            flex-shrink: 0;
        }
        .achievement-toast .ach-body {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        .achievement-toast .ach-label {
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-dim);
        }
        .achievement-toast .ach-title {
            font-family: 'Fredoka', 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--focus-ring);
            white-space: nowrap;
        }

        /* ─── Theme Picker ─── */
        .theme-picker {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .theme-btn {
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 0.72rem;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 50px;
            background: var(--frost-surface);
            border: 1px solid var(--frost-border);
            color: var(--text-dim);
            cursor: pointer;
            transition: all var(--transition);
        }
        .theme-btn:hover {
            background: rgba(56, 189, 248, 0.1);
            color: var(--text-light);
        }
        .theme-btn.active {
            background: rgba(56, 189, 248, 0.18);
            border-color: rgba(56, 189, 248, 0.35);
            color: var(--text-bright);
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.15);
        }
        .daily-badge {
            display: inline-block;
            font-size: 0.6rem;
            font-weight: 700;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #0b1628;
            padding: 1px 6px;
            border-radius: 50px;
            margin-left: 4px;
            vertical-align: middle;
        }

        /* ─── Board Actions Row ─── */
        .board-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* ─── Challenge Viewer Mode ─── */
        .challenge-viewer .theme-picker,
        .challenge-viewer .hud-row,
        .challenge-viewer .board-actions { display: none; }
        .challenge-viewer .grid-cell { pointer-events: none; cursor: default; }

        .challenge-banner {
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        .challenge-viewer .challenge-banner { display: flex; }

        .challenge-banner p {
            font-size: 1.05rem;
            color: var(--text-light);
            line-height: 1.5;
            margin: 0;
        }
        .challenge-banner strong {
            color: var(--text-bright);
        }

        .challenge-cta {
            font-family: 'Fredoka', 'Inter', sans-serif;
            padding: 0.85rem 2.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--focus-ring), #0ea5e9);
            color: var(--bg-deep);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all var(--transition);
            box-shadow:
                0 4px 0 #0369a1,
                0 6px 20px rgba(56, 189, 248, 0.35);
        }
        .challenge-cta:hover {
            transform: translateY(-2px);
            box-shadow:
                0 6px 0 #0369a1,
                0 10px 30px rgba(56, 189, 248, 0.45);
        }
        .challenge-cta:focus-visible {
            outline: 3px solid var(--text-bright);
            outline-offset: 2px;
        }
        .challenge-cta:active {
            transform: translateY(2px);
            box-shadow:
                0 1px 0 #0369a1,
                0 2px 8px rgba(56, 189, 248, 0.25);
        }

        /* ─── Share Button ─── */
        .share-btn {
            display: inline-flex;
            align-items: center;
            gap: 7px;
            font-family: 'Fredoka', 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.55rem 1.5rem;
            background: var(--frost-surface);
            border: 1px solid var(--frost-border);
            border-radius: 50px;
            color: var(--text-light);
            cursor: pointer;
            transition: all var(--transition);
            box-shadow:
                0 3px 0 rgba(255, 255, 255, 0.04),
                0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .share-btn svg {
            width: 14px;
            height: 14px;
        }

        .share-btn:hover {
            background: rgba(56, 189, 248, 0.12);
            border-color: rgba(56, 189, 248, 0.25);
            color: var(--text-bright);
            box-shadow:
                0 3px 0 rgba(255, 255, 255, 0.04),
                0 6px 18px rgba(0, 0, 0, 0.25);
            transform: translateY(-1px);
        }

        .share-btn:active {
            transform: translateY(1px);
            box-shadow:
                0 1px 0 rgba(255, 255, 255, 0.04),
                0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .share-btn:focus-visible {
            outline: 3px solid var(--focus-ring);
            outline-offset: 2px;
        }

        /* ─── Overlay Actions Row ─── */
        .overlay-actions {
            display: flex;
            gap: 12px;
            align-items: stretch;
            justify-content: center;
            width: 100%;
        }

        .overlay-actions button {
            flex: 1;
            min-width: 0;
        }

        .overlay-share-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-light);
            font-size: 1rem;
            padding: 0.75rem 1.8rem;
            box-shadow:
                0 3px 0 rgba(255, 255, 255, 0.04),
                0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .overlay-share-btn:hover {
            background: rgba(255, 255, 255, 0.14);
            border-color: rgba(255, 255, 255, 0.25);
            color: var(--text-bright);
        }

        /* ─── Board Frame ─── */
        .board-frame {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-xl);
            padding: 14px;
            box-shadow:
                0 0 60px var(--frame-glow),
                inset 0 1px 1px rgba(255, 255, 255, 0.04);
            width: 100%;
            overflow: hidden;
        }

        /* ─── Bingo Grid ─── */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 7px;
            width: 100%;
        }

        /* ─── Ice Tile Cells ─── */
        .grid-cell {
            aspect-ratio: 1;
            background: linear-gradient(155deg, var(--tile-from) 0%, var(--tile-mid) 60%, var(--tile-to) 100%);
            border: 1px solid var(--ice-border);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
            text-align: center;
            font-size: 0.74rem;
            font-weight: 600;
            line-height: 1.25;
            cursor: pointer;
            transition: transform var(--transition), box-shadow var(--transition);
            box-shadow:
                0 4px 0 var(--ice-edge),
                0 6px 14px rgba(0, 0, 0, 0.25),
                inset 0 2px 3px rgba(255, 255, 255, 0.7);
            position: relative;
            overflow: hidden;
            color: var(--ice-text);
        }

        .grid-cell:hover {
            transform: translateY(-3px);
            box-shadow:
                0 7px 0 var(--ice-edge),
                0 10px 24px rgba(0, 0, 0, 0.3),
                inset 0 2px 3px rgba(255, 255, 255, 0.7);
        }

        .grid-cell:active {
            transform: translateY(2px);
            box-shadow:
                0 1px 0 var(--ice-edge),
                0 2px 6px rgba(0, 0, 0, 0.2),
                inset 0 2px 3px rgba(255, 255, 255, 0.5);
        }

        /* Focus ring on label when child input is focused (WCAG 2.4.7) */
        .grid-cell:focus-within {
            outline: 3px solid var(--focus-ring);
            outline-offset: 2px;
        }

        .grid-cell input {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 6;
        }

        .grid-cell input:focus-visible {
            outline: none;
        }

        .grid-cell span {
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            word-wrap: break-word;
            overflow: hidden;
            border-radius: calc(var(--radius-md) - 3px);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            padding: 2px;
        }

        /* ── Checked = Cracked ice revealing aurora beneath ── */
        .grid-cell:has(input:checked) {
            box-shadow:
                0 4px 0 var(--checked-edge),
                0 6px 14px rgba(0, 0, 0, 0.3),
                0 0 22px var(--cracked-glow),
                inset 0 2px 3px rgba(255, 255, 255, 0.15);
            background: linear-gradient(155deg, var(--checked-from) 0%, var(--checked-mid) 50%, var(--checked-to) 100%);
        }

        .grid-cell input:checked + span {
            background: linear-gradient(135deg, var(--checked-span-from) 0%, var(--checked-span-to) 100%);
            color: var(--text-bright);
            font-weight: 700;
            animation: iceBreak 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /*
         * WCAG 1.4.1 (Use of Color): checked state is conveyed by
         * the crack-line texture overlay, aurora gradient background,
         * and the 3D depth-shadow shift — not color alone.
         */

        /* ── Ice-crack overlay on checked cells ── */
        .grid-cell:has(input:checked)::after {
            content: '';
            position: absolute;
            inset: 0;
            z-index: 4;
            pointer-events: none;
            border-radius: inherit;
            background:
                /* Main diagonal crack */
                linear-gradient(130deg,
                    transparent 36%, rgba(255,255,255,0.55) 36%, rgba(255,255,255,0.55) 36.5%, transparent 36.5%,
                    transparent 63%, rgba(255,255,255,0.40) 63%, rgba(255,255,255,0.40) 63.5%, transparent 63.5%),
                /* Branch crack upper-right */
                linear-gradient(68deg,
                    transparent 42%, rgba(255,255,255,0.35) 42%, rgba(255,255,255,0.35) 42.4%, transparent 42.4%),
                /* Branch crack lower-left */
                linear-gradient(172deg,
                    transparent 52%, rgba(255,255,255,0.30) 52%, rgba(255,255,255,0.30) 52.4%, transparent 52.4%),
                /* Small fracture spur */
                linear-gradient(30deg,
                    transparent 69%, rgba(255,255,255,0.25) 69%, rgba(255,255,255,0.25) 69.3%, transparent 69.3%),
                /* Micro fracture */
                linear-gradient(95deg,
                    transparent 28%, rgba(255,255,255,0.20) 28%, rgba(255,255,255,0.20) 28.3%, transparent 28.3%);
            animation: cracksReveal 0.5s ease-out forwards;
        }

        /* ── Impact flash on checked cells ── */
        .grid-cell:has(input:checked)::before {
            content: '';
            position: absolute;
            inset: 0;
            z-index: 5;
            pointer-events: none;
            border-radius: inherit;
            background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.85) 0%, rgba(200, 230, 255, 0.35) 35%, transparent 65%);
            animation: iceFlash 0.45s ease-out forwards;
        }

        /* ── Ice Shard Particles ── */
        .ice-shard {
            position: fixed;
            pointer-events: none;
            z-index: 100;
            background: linear-gradient(135deg, rgba(218, 233, 246, 0.95), rgba(168, 196, 220, 0.8));
            clip-path: polygon(15% 0%, 85% 5%, 100% 55%, 75% 100%, 5% 80%);
            box-shadow: 0 0 4px rgba(200, 225, 255, 0.6);
            animation: shardFly 0.65s ease-out forwards;
        }

        /* Alternate shard shape */
        .ice-shard:nth-child(odd) {
            clip-path: polygon(50% 0%, 95% 30%, 80% 100%, 10% 85%, 0% 20%);
        }

        /* ── Gold Star Center Cell ── */
        .center-cell {
            background: linear-gradient(155deg, var(--center-from) 0%, var(--center-mid) 40%, var(--center-to) 100%) !important;
            border: 1px solid rgba(255, 255, 255, 0.35) !important;
            color: var(--text-bright);
            box-shadow:
                0 4px 0 var(--center-edge),
                0 6px 14px rgba(0, 0, 0, 0.3),
                0 0 28px var(--center-glow),
                inset 0 2px 4px rgba(255, 255, 255, 0.35) !important;
            animation: goldPulse 3s ease-in-out infinite;
        }

        .center-cell:hover {
            transform: translateY(-3px);
            box-shadow:
                0 7px 0 var(--center-edge),
                0 10px 24px rgba(0, 0, 0, 0.35),
                0 0 40px var(--center-glow),
                inset 0 2px 4px rgba(255, 255, 255, 0.35) !important;
        }

        /* 3D gold star */
        .center-cell .star-3d {
            width: 55%;
            height: 55%;
            position: relative;
            /* filter set inline by JS per theme */
        }

        /* Base star shape — golden gradient with metallic sheen */
        .center-cell .star-3d .star-base {
            fill: url(#goldGradient);
        }

        /* Highlight facet — lighter top-left for 3D bevel */
        .center-cell .star-3d .star-highlight {
            fill: url(#goldHighlight);
            opacity: 0.6;
        }

        /* ─── Bottom Ad (mobile) ─── */
        .ad-bottom {
            display: none;
            width: 100%;
            padding: 0 16px 16px;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .ad-bottom .ad-slot {
            width: 100%;
            max-width: 728px;
            height: 60px;
        }

        /* ─── Footer ─── */
        .footer {
            text-align: center;
            padding: 12px 16px 20px;
            font-size: 0.8rem;
            color: var(--text-dim);
            position: relative;
            z-index: 1;
        }

        /* ─── Animations ─── */
        @keyframes iceBreak {
            0%   { transform: scale(1) rotate(0deg); }
            12%  { transform: scale(1.08) rotate(-1.5deg); }
            24%  { transform: scale(0.96) rotate(1deg); }
            36%  { transform: scale(1.04) rotate(-0.5deg); }
            50%  { transform: scale(0.98) rotate(0.3deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes cracksReveal {
            0%   { opacity: 0; clip-path: circle(0% at 50% 50%); }
            40%  { opacity: 1; }
            100% { opacity: 1; clip-path: circle(100% at 50% 50%); }
        }

        @keyframes iceFlash {
            0%   { opacity: 1; transform: scale(0.3); }
            100% { opacity: 0; transform: scale(1.2); }
        }

        @keyframes shardFly {
            0% {
                transform: translate(0, 0) rotate(0deg) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--shard-dx), var(--shard-dy)) rotate(var(--shard-rot)) scale(0.2);
                opacity: 0;
            }
        }

        @keyframes goldPulse {
            0%, 100% { box-shadow:
                0 4px 0 #92400e,
                0 6px 14px rgba(0, 0, 0, 0.3),
                0 0 28px rgba(251, 191, 36, 0.35),
                inset 0 2px 4px rgba(255, 255, 255, 0.35);
            }
            50% { box-shadow:
                0 4px 0 #92400e,
                0 6px 14px rgba(0, 0, 0, 0.3),
                0 0 44px rgba(251, 191, 36, 0.55),
                inset 0 2px 4px rgba(255, 255, 255, 0.35);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(24px) scale(0.95); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes celebrateBounce {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25%  { transform: scale(1.15) rotate(-3deg); }
            50%  { transform: scale(1.05) rotate(2deg); }
            75%  { transform: scale(1.1) rotate(-1deg); }
        }

        @keyframes sparklefall {
            0% {
                transform: translateY(-10vh) rotate(0deg);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 0.8; }
            100% {
                transform: translateY(110vh) rotate(540deg);
                opacity: 0;
            }
        }

        /* ─── Reduced Motion (WCAG 2.3.3) ─── */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .snowflakes {
                display: none;
            }
        }

        /* ─── Celebration Overlay ─── */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(11, 22, 40, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .overlay-card {
            background: linear-gradient(165deg, #1e3a5f 0%, #0f1f3d 100%);
            border: 1px solid rgba(56, 189, 248, 0.2);
            border-radius: var(--radius-xl);
            padding: 2.5rem 3rem;
            text-align: center;
            box-shadow:
                0 8px 40px rgba(0, 0, 0, 0.4),
                0 0 60px rgba(56, 189, 248, 0.1);
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 400px;
            width: 90%;
        }

        .overlay-card .trophy {
            font-size: 4rem;
            line-height: 1;
            margin-bottom: 0.75rem;
            animation: celebrateBounce 1.5s ease-in-out infinite;
        }

        .overlay-card h2 {
            font-family: 'Fredoka', 'Inter', sans-serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-bright);
            margin-bottom: 0.5rem;
            text-shadow: 0 0 24px rgba(56, 189, 248, 0.4);
        }

        .overlay-card p {
            font-size: 1rem;
            color: var(--text-dim);
            margin-bottom: 1.75rem;
            line-height: 1.5;
        }

        .overlay-card button {
            font-family: 'Fredoka', 'Inter', sans-serif;
            padding: 0.85rem 2.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--focus-ring), #0ea5e9);
            color: var(--bg-deep);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all var(--transition);
            box-shadow:
                0 4px 0 #0369a1,
                0 6px 20px rgba(56, 189, 248, 0.35);
        }

        .overlay-card button:hover {
            transform: translateY(-2px);
            box-shadow:
                0 6px 0 #0369a1,
                0 10px 30px rgba(56, 189, 248, 0.45);
        }

        .overlay-card button:focus-visible {
            outline: 3px solid var(--text-bright);
            outline-offset: 2px;
        }

        .overlay-card button:active {
            transform: translateY(2px);
            box-shadow:
                0 1px 0 #0369a1,
                0 2px 8px rgba(56, 189, 248, 0.25);
        }

        /* ─── Blackout Celebration ─── */
        .overlay.blackout {
            background: rgba(5, 5, 20, 0.92);
        }

        /* God rays – on the overlay itself, behind the card */
        .overlay.blackout::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200vmax;
            height: 200vmax;
            transform: translate(-50%, -50%);
            z-index: 0;
            pointer-events: none;
            background: conic-gradient(
                from 0deg,
                rgba(251, 191, 36, 0.35) 0deg,   transparent 8deg,
                transparent 22.5deg, rgba(245, 158, 11, 0.30) 22.5deg, transparent 30.5deg,
                transparent 45deg,   rgba(253, 230, 138, 0.35) 45deg,  transparent 53deg,
                transparent 67.5deg, rgba(251, 191, 36, 0.30) 67.5deg, transparent 75.5deg,
                transparent 90deg,   rgba(245, 158, 11, 0.35) 90deg,   transparent 98deg,
                transparent 112.5deg,rgba(253, 230, 138, 0.30) 112.5deg,transparent 120.5deg,
                transparent 135deg,  rgba(251, 191, 36, 0.35) 135deg,  transparent 143deg,
                transparent 157.5deg,rgba(245, 158, 11, 0.30) 157.5deg,transparent 165.5deg,
                transparent 180deg,  rgba(253, 230, 138, 0.35) 180deg, transparent 188deg,
                transparent 202.5deg,rgba(251, 191, 36, 0.30) 202.5deg,transparent 210.5deg,
                transparent 225deg,  rgba(245, 158, 11, 0.35) 225deg,  transparent 233deg,
                transparent 247.5deg,rgba(253, 230, 138, 0.30) 247.5deg,transparent 255.5deg,
                transparent 270deg,  rgba(251, 191, 36, 0.35) 270deg,  transparent 278deg,
                transparent 292.5deg,rgba(245, 158, 11, 0.30) 292.5deg,transparent 300.5deg,
                transparent 315deg,  rgba(253, 230, 138, 0.35) 315deg, transparent 323deg,
                transparent 337.5deg,rgba(251, 191, 36, 0.30) 337.5deg,transparent 345.5deg,
                transparent 360deg
            );
            animation: godRaysSpin 20s linear infinite, godRaysFade 0.8s ease-out forwards;
            border-radius: 50%;
            mask-image: radial-gradient(circle, white 15%, transparent 65%);
            -webkit-mask-image: radial-gradient(circle, white 15%, transparent 65%);
        }

        /* Ray sparkles container – rotates with god rays */
        .ray-sparkles {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200vmax;
            height: 200vmax;
            transform: translate(-50%, -50%);
            z-index: 0;
            pointer-events: none;
            border-radius: 50%;
            animation: godRaysSpin 20s linear infinite, godRaysFade 1s ease-out forwards;
        }
        .ray-sparkle {
            position: absolute;
            border-radius: 50%;
            animation: rayTwinkle var(--twinkle-dur, 1.2s) ease-in-out var(--twinkle-delay, 0s) infinite;
        }

        @keyframes godRaysSpin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        @keyframes godRaysFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes rayTwinkle {
            0%, 100% { opacity: 0.15; transform: translate(-50%, -50%) scale(0.6); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
        }

        .overlay.blackout .overlay-card {
            background: linear-gradient(165deg, #1a1040 0%, #0a0520 100%);
            border-color: rgba(251, 191, 36, 0.4);
            box-shadow:
                0 0 80px rgba(251, 191, 36, 0.25),
                0 25px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 2;
        }

        .overlay.blackout .overlay-card .trophy {
            font-size: 5rem;
            animation: blackoutStar 1.5s ease-in-out infinite;
        }
        .overlay.blackout .overlay-card h2 {
            font-size: 2.8rem;
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #fde68a, #f59e0b);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: goldShimmer 2s linear infinite;
            text-shadow: none;
        }
        .overlay.blackout .overlay-card p {
            color: var(--text-light);
        }
        @keyframes blackoutStar {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(5deg); }
            50% { transform: scale(1) rotate(0deg); }
            75% { transform: scale(1.1) rotate(-5deg); }
        }
        @keyframes goldShimmer {
            0% { background-position: 100% 50%; }
            100% { background-position: -100% 50%; }
        }

        /* ─── Celebration Particles (Sparkles) ─── */
        .particle {
            position: fixed;
            pointer-events: none;
            animation: sparklefall linear forwards;
            z-index: 999;
        }

        /* ─── Fireworks ─── */
        .firework-burst {
            position: fixed;
            pointer-events: none;
            z-index: 1;
            width: 0;
            height: 0;
        }
        .firework-spark {
            position: absolute;
            border-radius: 50%;
            top: 0;
            left: 0;
            transform: translate(-50%, -50%);
            animation: fireworkExplode var(--fw-duration, 1.4s) cubic-bezier(0.22, 0, 0.3, 1) forwards;
            --fw-x: 0px;
            --fw-y: 0px;
        }
        .firework-spark.spark-core {
            width: 8px;
            height: 8px;
        }
        .firework-spark.spark-outer {
            width: 5px;
            height: 5px;
        }
        .firework-spark.spark-crackle {
            width: 4px;
            height: 4px;
        }
        .firework-spark::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: inherit;
            filter: blur(4px);
            opacity: 0.5;
        }
        .firework-flash {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            top: 0;
            left: 0;
            transform: translate(-50%, -50%);
            animation: fireworkFlash 0.4s ease-out forwards;
            pointer-events: none;
        }
        .firework-trail {
            position: fixed;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
            animation: fireworkRise var(--trail-duration, 0.6s) cubic-bezier(0.2, 0.8, 0.3, 1) forwards;
            --trail-target-y: 0px;
        }
        .firework-trail::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 20px;
            background: linear-gradient(to top, transparent, inherit);
            border-radius: 2px;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.4;
        }
        @keyframes fireworkRise {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            60% { opacity: 1; transform: translateY(calc(var(--trail-target-y) * 0.6)) scale(0.8); }
            100% {
                opacity: 0;
                transform: translateY(var(--trail-target-y)) scale(0.3);
            }
        }
        @keyframes fireworkExplode {
            0% {
                transform: translate(-50%, -50%) translate(0, 0) scale(1.5);
                opacity: 1;
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) translate(calc(var(--fw-x) * 0.6), calc(var(--fw-y) * 0.6)) scale(1);
            }
            100% {
                transform: translate(-50%, -50%) translate(var(--fw-x), var(--fw-y)) scale(0);
                opacity: 0;
            }
        }
        @keyframes fireworkFlash {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(3); opacity: 0.6; }
            100% { transform: translate(-50%, -50%) scale(5); opacity: 0; }
        }

        /* ─── Responsive: Hide sidebars ─── */
        @media (max-width: 1080px) {
            .ad-sidebar {
                display: none;
            }

            .page-wrapper {
                max-width: var(--content-max);
            }

            .ad-bottom {
                display: flex;
            }
        }

        /* ─── Responsive: Tablet ─── */
        @media (max-width: 640px) {
            .header h1 {
                font-size: 2rem;
            }

            .header p {
                font-size: 0.82rem;
            }

            .stat-item {
                padding: 4px 10px;
                gap: 5px;
            }

            .stat-value {
                font-size: 1rem;
            }

            .grid-container {
                gap: 5px;
            }

            .grid-cell {
                font-size: 0.65rem;
                padding: 4px;
                border-radius: var(--radius-sm);
            }

            .grid-cell span {
                border-radius: calc(var(--radius-sm) - 2px);
            }

            .board-frame {
                padding: 10px;
                border-radius: var(--radius-lg);
            }

            .ad-leaderboard .ad-slot {
                height: 60px;
            }

            .ad-bottom .ad-slot {
                height: 50px;
            }

            .overlay-card {
                padding: 2rem;
            }

            .overlay-card .trophy {
                font-size: 3rem;
            }

            .overlay-card h2 {
                font-size: 1.6rem;
            }

            .overlay-card p {
                font-size: 0.9rem;
            }

            .overlay-card button {
                padding: 0.75rem 2rem;
                font-size: 1rem;
            }
        }

        /* ─── Responsive: Small phones ─── */
        @media (max-width: 380px) {
            .header h1 {
                font-size: 1.7rem;
            }

            .grid-cell {
                font-size: 0.6rem;
                padding: 3px;
                box-shadow:
                    0 3px 0 var(--ice-edge),
                    0 4px 8px rgba(0, 0, 0, 0.25),
                    inset 0 1px 2px rgba(255, 255, 255, 0.6);
            }

            .stat-item {
                padding: 3px 8px;
                gap: 4px;
            }

            .stat-value {
                font-size: 0.95rem;
            }

            .stat-label {
                font-size: 0.6rem;
            }

            .board-frame {
                padding: 8px;
            }

            .grid-container {
                gap: 4px;
            }
        }
    </style>
</head>
<body>
    <!-- Skip Navigation (WCAG 2.4.1) -->
    <a href="#bingo-game" class="skip-link">Skip to game board</a>

    <!-- Decorative floating snowflakes -->
    <div class="snowflakes" id="particleContainer" aria-hidden="true"></div>

    <!-- Top Leaderboard Ad -->
    <div class="ad-leaderboard" role="complementary" aria-label="Advertisement">
        <div class="ad-slot" id="adLeaderboard">Ad Space &mdash; 728 &times; 90</div>
    </div>

    <div class="page-wrapper">
        <!-- Left Sidebar Ad -->
        <aside class="ad-sidebar ad-sidebar-left" aria-label="Left advertisement">
            <div class="ad-slot" id="adSidebarLeft">Ad Space &mdash; 300 &times; 250</div>
        </aside>

        <!-- Main Game Content -->
        <main class="main-content" id="bingo-game" tabindex="-1" style="position:relative;">
            <header class="header">
                <h1>Icebreaker Bingo</h1>
                <p>Check every square that sounds like you, then share it!</p>
            </header>

            <div class="theme-picker" id="themePicker" aria-label="Choose a theme"></div>

            <div class="hud-row">
                <div class="stats-bar" role="status" aria-live="polite" aria-atomic="true" aria-label="Game statistics">
                    <div class="stat-item">
                        <span class="stat-label" id="checkedLabel">Checked</span>
                        <span class="stat-value" id="checkedCount" aria-labelledby="checkedLabel">0</span>
                    </div>
                    <div class="stat-divider" aria-hidden="true"></div>
                    <div class="stat-item">
                        <span class="stat-label" id="bingosLabel">Bingos</span>
                        <span class="stat-value" id="winsCount" aria-labelledby="bingosLabel">0</span>
                    </div>
                </div>
                <button class="sound-toggle hint-pulse" id="soundToggle" aria-label="Toggle sound" title="Toggle sound effects">
                    <svg class="icon-on" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                    <svg class="icon-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>
                    <span class="sound-label-off">Sound</span>
                    <span class="sound-label-on">Sound</span>
                </button>
            </div>

            <section class="board-frame">
                <div class="grid-container" id="gridContainer" role="grid" aria-label="Bingo board"></div>
            </section>

            <div class="board-actions">
                <button class="reset-btn" id="resetBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                        <path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                    </svg>
                    New Board
                </button>
                <button class="share-btn" id="shareBtn" aria-label="Share board image">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                        <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                    </svg>
                    Share
                </button>
            </div>

            <!-- Challenge Link Landing Banner -->
            <div class="challenge-banner" id="challengeBanner">
                <p id="challengeMessage"></p>
                <button class="challenge-cta" id="challengeCta">Play Icebreaker Bingo</button>
            </div>
        </main>

        <!-- Right Sidebar Ad -->
        <aside class="ad-sidebar ad-sidebar-right" aria-label="Right advertisement">
            <div class="ad-slot" id="adSidebarRight">Ad Space &mdash; 300 &times; 250</div>
        </aside>
    </div>

    <!-- Bottom Ad (visible when sidebars are hidden) -->
    <div class="ad-bottom" role="complementary" aria-label="Advertisement">
        <div class="ad-slot" id="adBottom">Ad Space &mdash; 728 &times; 90</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- Celebration Overlay -->
    <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-labelledby="overlayTitle" aria-describedby="overlayDesc">
        <div class="overlay-card">
            <div class="trophy" role="img" aria-hidden="true">&#127881;</div>
            <h2 id="overlayTitle">Bingo!</h2>
            <p id="overlayDesc">You broke the ice! Spread the fun — share your board.</p>
            <div class="overlay-actions">
                <button id="newBoardBtn">Keep Playing</button>
                <button class="share-btn overlay-share-btn" id="overlayShareBtn" aria-label="Share board image">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                        <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                    </svg>
                    Share
                </button>
            </div>
        </div>
    </div>

    <!-- Share Panel Overlay -->
    <div class="share-overlay" id="shareOverlay" aria-hidden="true">
        <div class="share-panel" role="dialog" aria-modal="true" aria-labelledby="sharePanelTitle">
            <button class="share-panel-close" id="sharePanelClose" aria-label="Close share panel">&times;</button>
            <h3 class="share-panel-title" id="sharePanelTitle">Share Your Board</h3>
            <p class="share-panel-hint" id="sharePanelHint">
                <span class="hint-icon">&#10003;</span> Image copied to clipboard &mdash; paste it in your post!
            </p>
            <div class="share-platforms">
                <!-- X / Twitter -->
                <button class="platform-btn" data-platform="x" aria-label="Share on X">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                    <span class="platform-label">X</span>
                </button>
                <!-- Threads -->
                <button class="platform-btn" data-platform="threads" aria-label="Share on Threads">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12.186 24h-.007c-3.581-.024-6.334-1.205-8.184-3.509C2.35 18.44 1.5 15.586 1.472 12.01v-.017c.03-3.579.879-6.43 2.525-8.482C5.845 1.205 8.6.024 12.18 0h.014c2.746.02 5.043.725 6.826 2.098 1.677 1.29 2.858 3.13 3.509 5.467l-2.04.569c-1.104-3.96-3.898-5.984-8.304-6.015-2.91.022-5.11.936-6.54 2.717C4.307 6.504 3.616 8.914 3.59 12c.025 3.086.718 5.496 2.057 7.164 1.432 1.783 3.631 2.698 6.54 2.717 2.623-.02 4.358-.631 5.8-2.045 1.647-1.613 1.618-3.593 1.09-4.798-.31-.71-.873-1.3-1.634-1.75-.192 1.352-.622 2.446-1.284 3.272-.886 1.102-2.14 1.704-3.73 1.79-1.202.065-2.361-.218-3.259-.801-1.063-.689-1.685-1.74-1.752-2.96-.065-1.18.408-2.26 1.332-3.04.88-.744 2.107-1.17 3.546-1.23 1.078-.046 2.06.08 2.94.353-.08-.94-.38-1.672-.91-2.164-.62-.576-1.538-.862-2.726-.862h-.07c-.94.013-1.753.295-2.418.84l-1.345-1.56c.957-.784 2.142-1.2 3.521-1.24h.108c1.722 0 3.1.488 4.097 1.45.912.882 1.428 2.1 1.54 3.624.38.2.734.428 1.06.686 1.073.85 1.835 1.97 2.207 3.24.538 1.84.378 4.1-1.428 5.878-1.87 1.838-4.127 2.609-7.322 2.632zM14.1 13.98c-.789-.034-2.467.088-2.667 1.776-.087.733.3 1.504 1.81 1.504.068 0 .139-.002.21-.006 1.564-.085 2.2-1.378 2.367-2.727-.524-.236-1.103-.42-1.72-.547z"/></svg>
                    <span class="platform-label">Threads</span>
                </button>
                <!-- Facebook -->
                <button class="platform-btn" data-platform="facebook" aria-label="Share on Facebook">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                    <span class="platform-label">Facebook</span>
                </button>
                <!-- Instagram -->
                <button class="platform-btn" data-platform="instagram" aria-label="Share on Instagram">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>
                    <span class="platform-label">Instagram</span>
                </button>
                <!-- WhatsApp -->
                <button class="platform-btn" data-platform="whatsapp" aria-label="Share on WhatsApp">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    <span class="platform-label">WhatsApp</span>
                </button>
                <!-- LinkedIn -->
                <button class="platform-btn" data-platform="linkedin" aria-label="Share on LinkedIn">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                    <span class="platform-label">LinkedIn</span>
                </button>
                <!-- Email -->
                <button class="platform-btn" data-platform="email" aria-label="Share via Email">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                    <span class="platform-label">Email</span>
                </button>
            </div>
            <div class="share-secondary">
                <button id="shareNativeBtn" style="display:none" aria-label="Share with image via AirDrop, Messages, and more">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                    Share via&hellip;
                </button>
                <button id="shareCopyBtn" aria-label="Copy image to clipboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    Copy Image
                </button>
                <button id="shareDownloadBtn" aria-label="Download board image">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Download
                </button>
                <button id="shareLinkBtn" aria-label="Copy challenge link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                    Copy Link
                </button>
            </div>
        </div>
    </div>

    <!-- Paste Coach (shown behind share popup) -->
    <div class="paste-coach" id="pasteCoach" aria-live="polite" aria-atomic="true">
        <div class="paste-coach-card">
            <p class="paste-coach-platform" id="pasteCoachPlatform"></p>

            <!-- Phase 1: Loading state -->
            <div class="paste-coach-loading" id="pasteCoachLoading">
                <p class="paste-coach-msg">Opening <strong id="pasteCoachLoadingName">Facebook</strong><span class="animated-ellipsis"></span></p>
            </div>

            <!-- Phase 2a: Paste instructions (X, Facebook, Threads, WhatsApp) -->
            <div class="paste-coach-instructions" id="pasteCoachPasteMode">
                <div class="paste-coach-keys">
                    <span class="paste-coach-key" id="pasteCoachModKey">&#8984;</span>
                    <span class="paste-coach-key-plus">+</span>
                    <span class="paste-coach-key">V</span>
                </div>
                <p class="paste-coach-msg">Paste your board image into your <strong id="pasteCoachTarget">post</strong></p>
            </div>

            <!-- Phase 2b: Upload instructions (Instagram) -->
            <div class="paste-coach-instructions" id="pasteCoachUploadMode">
                <p class="paste-coach-msg">Your board image has been saved to Downloads. Attach it to your post for the full effect.</p>
            </div>

            <!-- Phase 2c: Link-only instructions (LinkedIn) -->
            <div class="paste-coach-instructions" id="pasteCoachLinkMode">
                <p class="paste-coach-msg">Add a comment and share the link. A preview of the game will be included automatically.</p>
            </div>

            <button class="paste-coach-dismiss" id="pasteCoachDismiss">Got it</button>
        </div>
    </div>

    <!-- Toast notification -->
    <!-- Achievement toast -->
    <div class="achievement-toast" id="achievementToast" aria-live="polite" aria-atomic="true">
        <span class="ach-icon" aria-hidden="true">&#127942;</span>
        <div class="ach-body">
            <span class="ach-label">Achievement Unlocked</span>
            <span class="ach-title" id="achTitle"></span>
        </div>
    </div>

    <div class="share-toast" id="shareToast" aria-live="polite" aria-atomic="true">
        <span class="toast-icon"></span>
        <span class="toast-message"></span>
    </div>

    <!-- Screen reader announcement region -->
    <div id="srAnnounce" aria-live="assertive" aria-atomic="true" role="alert" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;"></div>

    <script>
        // ─── Themed Prompt Pools ───
        const themes = {
            classic: {
                name: 'Classic',
                prompts: [
            "Knows how to read tarot", "Knows sign language", "Appeared in a movie", "Met a celebrity",
            "Went viral online", "Owns a gaming computer", "Knows how to surf", "Has an unusual family tradition",
            "Loves true crime podcasts", "Likes pineapple on pizza", "Proposed to spouse in public", "Loves roller coasters",
            "Does Yoga", "Can do a cartwheel", "Rides horses", "Knows martial arts", "Started a club", "Attended a concert this year",
            "Has been to the Olympics", "Has a pen pal", "Has been on a reality show", "Spelling bee champ", "Has been on a road trip",
            "Sends holiday cards", "Screams during scary movies", "Loves karaoke", "Was lead in a play", "Can hula hoop",
            "Can bench press 150+ lbs", "Good at escape rooms", "Has been skydiving", "Won an eating competition", "Owns more novelty socks than plain ones",
            "Won at a casino", "Never flown on an airplane", "Never learned to ride a bike", "Collects something",
            "Goes all-out on holiday decorating", "Recently handmade a gift", "Received an award", "Has performed in public", "Has a phobia",
            "Has a BFF from high school", "Currently a student", "Took a how-to class recently", "Listens to podcasts",
            "Travels often", "Attended high school reunion", "Has food allergies", "Belongs to a club", "Named after a relative",
            "Has a scar", "Has broken a bone", "Has a nickname", "Birthday is on a holiday", "Has a bucket list",
            "Makes New Year's resolutions", "Good cook", "Taught a class", "Had a secret admirer", "Helped a stranger",
            "Got help from a stranger", "Worked at a family business", "Visited 4+ continents", "Took dance lessons", "Speaks 2+ languages",
            "Can code", "Won a contest", "Gardens", "Traveled in the last year", "Can bake a cake from scratch",
            "Knows the whole periodic table", "Can do basic car repairs", "Was in a wedding party this year", "Owns crypto",
            "Invests in the stock market", "Climbed a mountain", "Moved in the past year", "Owns a boat", "Has a big backyard",
            "Digital nomad", "Notary public", "Lives near a coffee shop", "Lives in a rural area", "Can drive manual transmission",
            "Reads newspapers", "Does stand up comedy", "Owns a vacation house", "Started a business", "Firefighter or EMT",
            "Has been in a hot air balloon", "Has taken a cruise", "Won a race", "Ran in a marathon", "Has a side hustle",
            "Regularly writes reviews", "Loves a good documentary", "Knows calligraphy", "Brews beer", "Built an app", "Mixologist",
            "Prefers remote work", "Prefers working in office", "Has a snack stash", "Drinks 3+ cups coffee a day",
            "Has been at the same company 3+ years", "Has worked in another industry", "Has a work music playlist", "Has a favorite pen",
            "Has a messy desk", "Has 0 unread emails", "Prefers working in the morning", "Prefers working at night",
            "Has been at the same company 2+ years", "Started their job less than a year ago", "Has had an 1hr+ commute", "Manager", "Runs errands during lunch break",
            "Buys coffee every morning", "Buys lunch every day", "Played prank on a coworker", "Works out before work",
            "Works out after work", "Has received a Shout Out", "Worked for a rival company", "Mentor", "Attends networking events",
            "Part of a professional group", "Organized a work outing", "Going on vacation soon", "Was promoted this year",
            "Switched departments this year", "Good at interviews", "Bad at interviews", "Hired an employee", "Led a project",
            "Planned a work party", "Only child", "Twin or triplet", "Comes from a big family", "Military family", "Parent",
            "Grandparent", "Lived in another country", "Hand-made an outfit", "In a sports league", "Plays an instrument",
            "Volunteers regularly", "Read 10+ books this year", "Wears contacts", "Has a cat", "Has a dog", "Has an exotic pet",
            "Runs regularly", "Has an unusual hobby", "Lives with roommates", "Has a tattoo", "Is left-handed", "Has officiated a wedding",
            "Has been scuba diving", "Double-jointed", "Uses a paper planner", "Vegetarian", "Introvert", "Extrovert", "Creates art",
            "Enjoys meeting new people", "Met partner through online dating", "Writer", "Got engaged this year", "Got married this year",
            "Bought a house this year", "Bought a car this year", "Had a baby this year", "Became debt-free this year",
            "Quit a bad habit recently", "Has a Masters or PhD", "Has a sweet tooth", "Has a hidden talent", "Child of immigrants",

            // ── Additional prompts ──
            "Has visited all 50 states", "Has been to Disneyland or Disney World", "Has traveled abroad solo",
            "Has slept in an airport", "Has gone white water rafting", "Has been zip-lining", "Has been bungee jumping",
            "Went camping recently", "Has been on a safari", "Has ridden a camel", "Has been to a volcano",
            "Traveled by train across a country", "Has taken a helicopter ride", "Has seen the Northern Lights",
            "Has gone parasailing", "Has been to a drive-in movie", "Has been to a theme park this year",
            "Can cook a dish from another culture", "Has eaten an insect", "Has gone wine tasting",
            "Makes their own pasta", "Has a signature dish", "Has tried durian", "Drinks tea every day",
            "Loves spicy food", "Can make sushi", "Keeps a sourdough starter", "Has tried escargot",
            "Has eaten at a Michelin-star restaurant", "Owns a cast-iron skillet", "Prefers tea over coffee",
            "Always orders the same restaurant meal", "Can juggle", "Can solve a Rubik's cube",
            "Can whistle with fingers", "Knows CPR", "Can change a flat tire", "Can type 80+ WPM",
            "Can do a headstand", "Knows origami", "Can do magic tricks", "Knows how to sew",
            "Has won a trivia night", "Can parallel park on the first try", "Can fold a fitted sheet",
            "Can do an impression of a celebrity", "Can name all the planets in order", "Can name all the zodiac signs",
            "Plays board games weekly", "Has completed a 1000+ piece puzzle", "Plays video games daily",
            "Collects vinyl records", "Watches anime", "Has seen a Broadway show", "Loves bird watching",
            "Does crossword puzzles", "Plays chess", "Has cosplayed", "Has been to Comic-Con",
            "Knits or crochets", "Does woodworking", "Has finished a coloring book", "Has been geocaching",
            "Has won a board game tournament", "Has tried axe throwing", "Has taken a pottery class",
            "Has been on TV", "Has met a world leader", "Has witnessed a natural disaster",
            "Has found a four-leaf clover", "Has had a paranormal experience", "Has been in a newspaper",
            "Has caught a foul ball at a game", "Has been a camp counselor", "Has been a lifeguard",
            "Has donated blood 5+ times", "Has done jury duty", "Has been stuck in an elevator",
            "Has won a costume contest", "Has written a love letter", "Has been in a flash mob",
            "Has a secret recipe", "Has swum with dolphins", "Has been whale watching",
            "Has made their own Halloween costume", "Has pulled a prank on April Fools",
            "Has met an online friend in person", "Has a secret handshake", "Has been to a haunted house",
            "Has done a polar plunge", "Has ridden a motorcycle", "Has been to a pro championship game",
            "Has done a Tough Mudder or Spartan", "Night owl", "Early bird", "Believes in aliens",
            "Has a lucky number", "Meditates regularly", "Journals daily", "Can nap anywhere",
            "Follows astrology", "Has a comfort show they rewatch", "Prefers books over movies",
            "Loves watching storms roll in", "Is always cold", "Sleeps with a fan on", "Wakes up without an alarm",
            "Has a morning routine over 1 hour", "Has binged a whole series in a weekend",
            "Has a go-to dad joke", "Has dyed their hair an unusual color", "Has lived in 3+ states",
            "Has a library card", "Knows their Myers-Briggs type", "Has a favorite conspiracy theory",
            "Has a collection of magnets", "Has a dream car", "Can recite a movie scene by heart",
            "Has re-read a book 3+ times", "Owns 20+ pairs of shoes", "Has a lucky charm",
            "Has given a talk to 100+ people", "Has worked in food service", "Has worked in retail",
            "Has worked a night shift", "Has been on a business trip abroad", "Is certified in their field",
            "Has taught someone to drive", "Studied abroad", "Changed careers",
            "Has pulled an all-nighter for work", "Brings lunch to work every day",
            "Has a smart home device", "Uses dark mode on everything", "Has built a PC",
            "Has a TikTok account", "Has 1000+ followers on social media", "Has a YouTube channel",
            "Listens to ASMR", "Has a 3D printer", "Remembers life before smartphones",
            "Has a mechanical keyboard", "Prefers Android over iPhone", "Prefers iPhone over Android",
            "Has a drone", "Has a fitness tracker", "Has a standing desk",
            "Has an indoor plant collection", "Built IKEA furniture without the manual",
            "Has completed a triathlon", "Can do 50+ push-ups", "Has been rock climbing",
            "Plays pickleball", "Goes snowboarding", "Has been ice skating this year",
            "Has bowled a 200+ game", "Has a black belt", "Plays golf", "Has won a sports trophy",
            "Swims regularly", "Cycles to work or school", "Has taken a self-defense class",
            "Has been a best man or maid of honor", "Married their high school sweetheart",
            "Adopted a pet from a shelter", "Is a godparent", "Has hosted a foreign exchange student",
            "Knows family tree 4+ generations back", "Named a pet after a celebrity",
            "Has fostered an animal", "Has been to a comedy show", "Has been to a farmers market this month",
            "Composts at home", "Has a very specific coffee order", "Has a pen name or alias",

            // ── Batch 2: Travel & Adventure ──
            "Has ridden a mechanical bull", "Has gone ice fishing", "Has taken a road trip solo",
            "Has been to a midnight movie premiere", "Has won a raffle", "Has been to a state fair",
            "Has been to a water park this year", "Has been to a drive-through safari",
            "Has been tubing on a river", "Has tried indoor skydiving", "Has been apple or berry picking",
            "Has been to a night market", "Has been to a lantern festival", "Has been to a haunted corn maze",
            "Has ridden in a limousine", "Has been to a demolition derby", "Has been to an escape room this year",
            "Has been to a pop-up restaurant", "Has tried wakeboarding", "Has gone paddle boarding",
            "Has been to a silent disco", "Has been to a cider mill", "Has been to a drive-in this year",
            "Has gone night swimming", "Has been fossil hunting", "Has been metal detecting",

            // ── Batch 2: Skills & Learning ──
            "Has tried pottery on a wheel", "Knows morse code", "Has taken a cooking class",
            "Has taken a photography class", "Can navigate without GPS", "Knows basic first aid",
            "Knows how to braid hair", "Has taken a sailing lesson", "Has taken a bartending class",
            "Can point out stars by name", "Can do a backflip", "Has tried archery",
            "Has tried glass blowing", "Has tried fencing", "Has tried aerial yoga or silks",
            "Knows how to pick a lock", "Can identify birds by their call", "Has completed an online course",
            "Learned a new instrument this year", "Has learned a new language this year",
            "Can name all 50 state capitals", "Has attended a TED talk or TEDx",

            // ── Batch 2: Food & Drink ──
            "Has a favorite local bakery", "Has a favorite food truck", "Has made their own jam or preserves",
            "Has made their own bread", "Has made their own ice cream", "Has made their own pizza dough",
            "Has made their own soap", "Has made their own candles", "Has a favorite smoothie recipe",
            "Has a meal prep routine", "Has hosted a dinner party", "Has a favorite comfort meal",
            "Has a favorite campfire recipe", "Has tried meal kit delivery", "Has a favorite dive bar",

            // ── Batch 2: Hobbies & Entertainment ──
            "Has written a poem", "Has a favorite hiking trail", "Has been to a planetarium",
            "Has been to a museum this month", "Has been to an art gallery opening",
            "Has been to a classical music concert", "Has a favorite book series",
            "Has built a blanket fort recently", "Has been indoor rock climbing",
            "Has played laser tag recently", "Has been bowling this month",
            "Has been to a botanical garden", "Has done a DIY home project",
            "Has been to a rooftop bar", "Has carved a pumpkin recently", "Has been to a vineyard",
            "Has attended a book signing", "Has been to a trampoline park", "Has been to a jazz club",
            "Has a favorite thrift store", "Has started a garden this year",
            "Has made their own holiday decorations", "Has written fan fiction",
            "Has been to a renaissance faire", "Has been line dancing",
            "Has been to a paint-and-sip event", "Has made a scrapbook",
            "Has been to a street art exhibit", "Has built a model kit",
            "Loves browsing bookstores", "Has made friendship bracelets",
            "Has been to a ballet or opera", "Has been to a cat cafe",
            "Has a vinyl record player", "Has made tie-dye",

            // ── Batch 2: Life & Quirks ──
            "Has a collection of mugs", "Has been to a flea market recently",
            "Has a signature dance move", "Has volunteered at an animal shelter",
            "Has a collection of 100+ books", "Has a subscription box",
            "Has a favorite coffee mug", "Has hand-written a letter recently",
            "Has tried acupuncture", "Has been to a spa this year",
            "Has a morning meditation practice", "Has painted a room this year",
            "Has a morning walk routine", "Has done a digital detox",
            "Has used a telescope for stargazing", "Has a favorite roller coaster",
            "Has tried float therapy", "Has a skincare routine",
            "Has organized a neighborhood event", "Has a favorite childhood candy",
            "Has a favorite walking trail", "Has a favorite audiobook",
            "Has used a typewriter", "Has a morning journaling practice",
            "Keeps a dream journal", "Has a collection of postcards",
            "Has completed a 30-day challenge", "Has a favorite uplifting quote",
            "Sleeps with a white noise machine", "Has a souvenir from every trip",
            "Has fixed something with duct tape", "Has a collection of stickers",
            "Has participated in a Secret Santa", "Has a favorite local coffee shop",

            // ── Batch 2: Sports & Fitness ──
            "Has participated in a fun run", "Has been to a professional soccer game",
            "Has a favorite board game", "Has done a charity walk or run",
            "Has been to an outdoor movie screening", "Has taken a hot yoga class",
            "Has a favorite scenic drive", "Has been to a pro basketball game",
            "Has been to a professional hockey game", "Has been to a pro baseball game",
            "Has been to a pro football game", "Has a pen collection",
            "Has tried ice climbing", "Has a toolbox at home", "Has participated in a protest or rally"
                ]
            },
            work: {
                name: 'Work',
                prompts: [
                    "Has been at the same company 3+ years", "Has been at the same company 2+ years", "Started their job less than a year ago",
                    "Has had an 1hr+ commute", "Manager", "Runs errands during lunch break",
                    "Buys coffee every morning", "Buys lunch every day", "Played prank on a coworker",
                    "Works out before work", "Works out after work", "Has received a Shout Out",
                    "Worked for a rival company", "Mentor to a colleague", "Attends networking events",
                    "Part of a professional group", "Organized a work outing", "Going on vacation soon",
                    "Was promoted this year", "Switched departments this year", "Good at interviews",
                    "Bad at interviews", "Has hired an employee", "Led a cross-team project",
                    "Planned a work party", "Prefers remote work", "Prefers working in office",
                    "Has a snack stash at their desk", "Drinks 3+ cups coffee a day",
                    "Has worked in another industry", "Listens to music while working",
                    "Has a favorite pen at work", "Has a messy desk", "Has 0 unread emails",
                    "Prefers working in the morning", "Prefers working at night",
                    "Brings lunch to work every day", "Has a standing desk",
                    "Has given a talk to 100+ people", "Is certified in their field",
                    "Has pulled an all-nighter for work", "Changed careers at least once",
                    "Started a business", "Has a side hustle", "Has been on a business trip abroad",
                    "Can name every coworker on their floor", "Has a pen they refuse to lend",
                    "Worked at a family business", "Has worked in food service",
                    "Has worked in retail", "Has worked a night shift",
                    "Has a very specific coffee order", "Has taught a class or workshop",
                    "Has a Masters or PhD", "Has a professional mentor",
                    "Has attended a conference this year", "Eats lunch at their desk",
                    "Has a work best friend", "Decorates their workspace",
                    "Takes walking meetings", "Has presented to an executive",

                    // ── Additional work prompts ──
                    "Has a plant at their desk", "Commutes by public transit",
                    "Has a favorite meeting room", "Knows the office WiFi password by heart",
                    "Always early to meetings", "Always late to meetings",
                    "Uses keyboard shortcuts for everything", "Has multiple monitors",
                    "Always volunteers for new projects", "Has a work catchphrase",
                    "Takes the stairs instead of elevator", "Has a go-to lunch spot nearby",
                    "Uses a whiteboard to brainstorm", "Has been employee of the month",
                    "Sends thank-you emails regularly", "Has mentored an intern",
                    "Knows everyone in the building", "Has a meeting-free day they protect",
                    "In an office fantasy sports league", "Has dressed up for a work theme day",
                    "Always has 100+ browser tabs open", "Worked on a product launch",
                    "Writes detailed meeting notes", "Has worked on a weekend voluntarily",
                    "Has a work anniversary coming up", "Has won a workplace award",
                    "Prefers Slack over email", "Prefers email over Slack",
                    "Has a signature email sign-off", "Always brings treats on Fridays",
                    "Knows how to fix the printer", "Has trained a new hire",
                    "Works through lunch sometimes", "Has a post-work ritual",
                    "Commutes less than 15 minutes", "Has a home office setup they love",
                    "Has negotiated a raise", "Has an ergonomic chair",
                    "Takes regular stretch breaks", "Has attended a team offsite",
                    "Has organized a team-building activity", "Has a work-from-home uniform",
                    "Uses time-blocking for tasks", "Knows the company founding story",
                    "Has participated in a hackathon at work", "Uses to-do lists religiously",
                    "Gave feedback that changed a process", "Loves a good spreadsheet",
                    "Always finishes projects early", "Last-minute worker who still nails it",
                    "Has taken a mental health day", "Has a favorite company swag item",
                    "Bikes or walks to work", "Has a work podcast to suggest",
                    "Has a five-year career plan", "Uses noise-canceling headphones at work",
                    "Has won a team competition", "Has a go-to vending machine pick",
                    "Has a work playlist they swear by", "Replies to emails within an hour",
                    "Has automated a tedious task", "Remembers names on the first day"
                ]
            },
            friends: {
                name: 'Friends',
                prompts: [
                    "Knows how to read tarot", "Met a celebrity", "Went viral online",
                    "Has hooked everyone on true crime", "Will die on the pineapple pizza hill", "Will drag you onto any roller coaster",
                    "Attended a concert this year", "Always first to sign up for karaoke", "The escape room MVP of the friend group",
                    "Has talked friends into skydiving", "Owns more novelty socks than plain ones", "Won at a casino",
                    "Never flown on an airplane", "Has a phobia", "Has a BFF from childhood",
                    "Has a nickname everyone uses", "Has a bucket list they always share", "The friend who cooks for everyone",
                    "Had a secret admirer", "Will recommend you an anime series", "Plays video games daily",
                    "Plays board games weekly", "Has a tattoo", "Can bust out an instrument at a party",
                    "Is the artistic one in the group", "Has a hidden talent that wows everyone", "Always down for late-night hangouts", "Annoyingly awake before everyone else",
                    "Can juggle", "Can solve a Rubik's cube", "Can do magic tricks",
                    "Has dyed their hair an unusual color", "Rewatches the same show over and over",
                    "Will debate aliens with you at 2am", "Has checked everyone's birth chart", "Has a go-to dad joke",
                    "Can do an impression of a celebrity", "Has a lucky charm",
                    "Has a dream car", "Has a secret handshake", "Collects something weird",
                    "Has been to a haunted house", "Has done a polar plunge",
                    "Has pulled a prank on April Fools", "Has been in a flash mob",
                    "Has cosplayed", "Has been to Comic-Con", "Knows all the lyrics to a 90s hit",
                    "Can recite a movie scene by heart", "Has won a costume contest",
                    "Has met an online friend in person", "Still has a childhood stuffed animal",
                    "Has a group chat that never stops", "Owns a matching friendship bracelet",
                    "Has crashed a party", "Always picks dare in truth or dare",
                    "Has stayed up all night talking", "Always late to hang outs",
                    "Always the one who plans the hang out", "Sends memes daily",

                    // ── Additional friends prompts ──
                    "Has a friendship over 20 years", "Always remembers birthdays",
                    "Has traveled abroad with friends", "Has a yearly friends-only trip",
                    "Gives the best gifts", "First to reply in the group chat",
                    "Has been a designated driver", "Has a friend in a band",
                    "Knows a friend's phone number by heart", "Does movie marathons with friends",
                    "Has been to a music fest with friends", "Always the one taking group photos",
                    "Has a matching tattoo with a friend", "Has pranked a friend on their birthday",
                    "Hosts game nights", "Knows friends' coffee orders by heart",
                    "Has helped a friend move", "Always suggests the restaurant",
                    "Has an inside joke no one else gets", "Has bailed a friend out of a bad spot",
                    "Has a friend in another country", "Reconnected with a long-lost friend",
                    "Has a friend from summer camp", "Always picks the music on road trips",
                    "Can do a spot-on impression of a friend", "Has laugh-cried with a friend",
                    "Always wins at party games", "Has roasted a friend at their birthday",
                    "Goes to trivia night regularly", "Organizes surprise parties",
                    "Watches a show weekly with a friend",
                    "Shares streaming passwords with friends",
                    "Has a friend who is also a neighbor", "Always has the best snacks at hangouts",
                    "Has been on a double date", "Has set up friends who started dating",
                    "Has done volunteer work with friends", "Still sees a college friend monthly",
                    "Always the last one to leave a party", "Always the first one to leave a party",
                    "Has matched outfits with a friend", "Has FaceTimed a friend for 2+ hours",
                    "Plays rec sports with friends", "Has a secret language with a friend",
                    "Has a favorite brunch spot with friends", "Has started a book club",
                    "Has a friend who's famous", "Always the hype person in the group",
                    "Has been a plus-one to a wedding", "Has a karaoke duet partner",
                    "Has carpooled with friends", "Has a yearly reunion with old friends",
                    "Has a friend from every stage of life", "Makes playlists for friends",
                    "Always wins the Halloween costume game",
                    "Has a New Year's Eve friend tradition",
                    "Has cried saying bye to a friend", "Sends voice notes instead of texts",
                    "Has binged a whole series with a friend",
                    "Has a go-to hangout spot with friends", "Has a friend they text every single day"
                ]
            },
            family: {
                name: 'Family',
                prompts: [
                    // ── Your role at family gatherings ──
                    "Falls asleep first at family gatherings", "Always sneaks food before dinner",
                    "Known as the family comedian", "Always the first to help clean up",
                    "Always the last one to arrive", "Is the loudest at the dinner table",
                    "Always brings a dish to every gathering", "Controls the music at family events",
                    "Takes the most photos at family events", "Is the family peacemaker",
                    "Always retells the same stories", "Always wants to play games after dinner",
                    "Is the one everyone comes to for advice", "Is the pickiest eater in the family",
                    "Always on their phone at gatherings", "The one who plans family get-togethers",
                    "Always gives the longest toast", "Gets emotional at family milestones",
                    "Can never keep a surprise", "Gives the most thoughtful gifts",
                    "Always goes back for seconds", "Still sits at the kids' table by choice",
                    "Always claims the best leftovers", "Volunteers to do the dishes",
                    "Brings up embarrassing old stories", "Is the designated family chef",
                    "Always the one to suggest a group photo", "Always has candy or gum to share",
                    "Falls asleep during family movie night", "Is the family bargain hunter",

                    // ── Personal skills & traits ──
                    "Can cook the family recipe from memory", "Has a hidden talent few people know",
                    "Speaks more than one language", "Plays a musical instrument",
                    "Can fix almost anything at home", "Is left-handed",
                    "Has a go-to party trick", "Remembers everyone's birthday by heart",
                    "Has a signature dish they always make", "Claims to be the board game champion",
                    "Considers themselves a card game shark", "Has the best sense of direction",
                    "Has the worst sense of direction", "Knows how to sew or mend clothes",
                    "Can still do a cartwheel", "Is the family tech support",
                    "Is the family baker", "Can name every cousin",
                    "Knows the family tree the best", "Has the best handwriting in the family",
                    "Can name a song from the first notes", "Has a relative's phone number memorized",
                    "Can drive a manual transmission", "Is the family gardener",
                    "Is the family trivia champion",

                    // ── Personal life experiences ──
                    "Has lived in another state", "Has lived in another country",
                    "Has a tattoo that surprised the family", "Has met someone famous",
                    "Has been on TV or in a newspaper", "Has gone skydiving or bungee jumping",
                    "Has run a race (5K or longer)", "Has changed careers at least once",
                    "Has been to 5+ countries", "Has a collection they're proud of",
                    "Has done karaoke in public", "Born in a different state or country",
                    "Has broken a bone", "Has a scar with a great story",
                    "Has been a best man or maid of honor", "Has officiated a wedding",
                    "Has volunteered in the past year", "Has hand-written a letter recently",
                    "Has pulled an all-nighter this year", "Has donated blood",
                    "Has done a DNA ancestry test", "Has eaten a food most people won't",
                    "Has danced at a family wedding", "Has built something with a relative",
                    "Has hosted a family event at home",

                    // ── Preferences & opinions ──
                    "Prefers Thanksgiving over Christmas", "Actually likes fruitcake",
                    "Prefers cats over dogs", "Prefers dogs over cats",
                    "Is a morning person", "Is a total night owl",
                    "Prefers mountains over the beach", "Prefers the beach over mountains",
                    "Secretly dislikes a family favorite", "Has a polarizing food take",
                    "Prefers cooking over baking", "Prefers baking over cooking",
                    "Can handle the spiciest food around", "Has a serious sweet tooth",
                    "Would rather host than be a guest", "Prefers texting over calling",
                    "Prefers calling over texting", "Would rather camp than stay in a hotel",
                    "Prefers books or podcasts over TV", "Is the tea drinker of the family",
                    "Has a comfort show on endless repeat", "Always orders the same restaurant meal",
                    "Sleeps with the fan on year-round",                     "Prefers wrapping gifts over gift bags",
                    "Has a go-to song to sing for family",

                    // ── Family position & milestones ──
                    "Named after a relative", "Is the oldest sibling",
                    "Is the youngest sibling", "Is a middle child",
                    "Only child", "Twin or triplet",
                    "Is a parent", "Is a grandparent",
                    "Is someone's godparent", "Looks just like a specific relative",
                    "Was the troublemaker growing up", "Was the rule-follower growing up",
                    "Married their high school sweetheart", "Got engaged or married this year",
                    "Started a new job or moved this year", "Recently hit a personal milestone"
                ]
            },
            dating: {
                name: 'First Date',
                prompts: [
                    "Wants to hit a theme park together", "Does Yoga", "Knows how to surf",
                    "Would binge true crime with you", "Has a hot take on pineapple pizza", "Would suggest karaoke on a date",
                    "Would ace an escape room date", "Has a secret talent worth asking about", "Has a sweet tooth",
                    "Has an adventurous bucket list to share", "Would love to cook dinner for you", "Speaks 2+ languages",
                    "Can bake a cake from scratch", "Might serenade you with an instrument", "Has a creative and artistic side",
                    "Has a nickname", "Has been skydiving and would go again", "Has been scuba diving",
                    "Loves a good documentary", "Listens to podcasts", "Loves to travel",
                    "Has taken a cruise", "Climbed a mountain", "Prefers late-night dates", "Loves early mornings and sunrise plans",
                    "Loves spicy food", "Prefers tea over coffee", "Into anime with picks to share",
                    "Has an unusual hobby", "Vegetarian", "Has a dog", "Has a cat",
                    "Prefers books over movies", "Has a comfort show they'd love to share",
                    "Will definitely ask your sign", "Wonders if we're alone in the universe", "Loves watching storms roll in",
                    "Can make sushi", "Has gone wine tasting", "Has seen a Broadway show",
                    "Meditates regularly", "Loves hiking", "Loves the beach",
                    "Prefers mountains over ocean", "Loves cooking for others",
                    "Has a favorite hole-in-the-wall spot", "Spontaneous traveler",
                    "Loves farmers markets", "Has a morning routine", "Journals regularly",
                    "Loves board game cafes", "Loves live music", "Has a favorite local park",
                    "Enjoys picnics", "Loves trying new cuisines", "Collects vinyl records",
                    "Has a go-to karaoke song", "Loves thrift shopping",
                    "Prefers small hangouts over big ones", "Has a green thumb",
                    "Loves stargazing", "Would rather cook than order in",

                    // ── Additional dating prompts ──
                    "Has a go-to first date spot", "Loves sunset walks",
                    "Loves road trips", "Has hosted a dinner party",
                    "Loves museums", "Has been to a food festival",
                    "Loves dancing", "Adventurous eater",
                    "Has a list of dream destinations", "Has been to a speakeasy",
                    "Loves trivia nights", "Has a favorite bookstore",
                    "Enjoys pottery or ceramics", "Has a creative side project",
                    "Loves to bake", "Can play a card game well",
                    "Has a signature cocktail", "Loves exploring new parts of town",
                    "Has taken a cooking class", "Loves sunrise hikes",
                    "Has been on a hot air balloon ride", "Always up for a puzzle challenge",
                    "Has kept a plant alive for 1+ year", "Enjoys photography",
                    "Loves going to the movies", "Prefers coffee dates",
                    "Has a favorite food truck", "Knows how to dance salsa",
                    "Enjoys camping", "Loves amusement parks",
                    "Has a favorite podcast to recommend", "Loves a good brunch",
                    "Prefers staying in over going out", "Has a creative side they downplay",
                    "Enjoys people-watching", "Has traveled to 5+ countries",
                    "Has a morning coffee ritual", "Loves arcade games",
                    "Has been horseback riding", "Enjoys volunteering",
                    "Has run a 5K or longer", "Loves a good playlist",
                    "Knows how to make a great omelette", "Has visited a vineyard",
                    "Loves mini golf", "Has been kayaking or canoeing",
                    "Has a go-to spot only locals know", "Loves watching cooking shows",
                    "Has attended a music festival", "Loves trying street food when traveling",
                    "Enjoys journaling or writing", "Has a pet they consider family",
                    "Loves going to comedy shows", "Loves aquariums",
                    "Has taken a dance class", "Knows how to grill",
                    "Has a favorite seasonal activity", "Has taken a spontaneous trip",
                    "Enjoys DIY projects", "Loves ice cream shops",
                    "Has been to a rooftop bar", "Would love to learn pottery",
                    "Has a favorite date-night recipe", "Loves trying local food while traveling"
                ]
            }
        };

        // ─── Game State ───
        let currentTheme = localStorage.getItem('ib_theme') || 'classic';
        let isDailyMode = localStorage.getItem('ib_daily') === 'true';
        let shuffled = [];
        let currentSeed = null;
        const grid = document.getElementById('gridContainer');
        const cells = Array(25).fill(false);
        const winningPatterns = [
            [0, 1, 2, 3, 4], [5, 6, 7, 8, 9], [10, 11, 12, 13, 14],
            [15, 16, 17, 18, 19], [20, 21, 22, 23, 24],
            [0, 5, 10, 15, 20], [1, 6, 11, 16, 21], [2, 7, 12, 17, 22],
            [3, 8, 13, 18, 23], [4, 9, 14, 19, 24],
            [0, 6, 12, 18, 24], [4, 8, 12, 16, 20]
        ];
        const completedPatterns = new Set();
        let wins = 0;
        const hitMilestones = new Set();

        // ─── Personality Titles ───
        const titleTiers = [
            [0, 'Wallflower'],
            [6, 'Getting Warmed Up'],
            [11, 'Social Butterfly'],
            [16, 'Life of the Party'],
            [21, 'Certified Icebreaker']
        ];
        let currentTitle = '';
        let suppressTitleToast = true;

        function getTitle(checked) {
            let title = titleTiers[0][1];
            for (const [min, name] of titleTiers) {
                if (checked >= min) title = name;
            }
            return title;
        }

        // ─── Seeded Shuffle (for daily/challenge) ───
        function seededRandom(seed) {
            let s = seed;
            return function () {
                s = (s * 16807 + 0) % 2147483647;
                return (s - 1) / 2147483646;
            };
        }

        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash) || 1;
        }

        function shuffleArray(array, seed) {
            const arr = [...array];
            if (seed !== undefined) {
                const rng = seededRandom(seed);
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(rng() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
            } else {
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
            }
            return arr;
        }

        // ─── Sound System ───
        const storedSound = localStorage.getItem('ib_sound');
        let soundEnabled = storedSound === 'on';
        const audioCtx = typeof AudioContext !== 'undefined' ? new AudioContext() : null;

        function playTone(freq, duration, type = 'sine', volume = 0.15) {
            if (!soundEnabled || !audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(volume, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // size: 0 = small, 0.5 = medium, 1 = large
        function playFireworkBoom(size = 0.5) {
            if (!soundEnabled || !audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;

            // Noise duration and volume scale with size
            const noiseDur = 0.15 + size * 0.35;
            const noiseVol = 0.06 + size * 0.12;

            // Noise burst for the explosion crackle
            const bufferSize = Math.floor(audioCtx.sampleRate * noiseDur);
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            const decayPow = 2 + (1 - size) * 3; // small = sharp decay, large = sustained
            for (let i = 0; i < bufferSize; i++) {
                data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufferSize, decayPow);
            }
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;

            // Filter: large = low rumble, small = high crackle
            const bpFilter = audioCtx.createBiquadFilter();
            bpFilter.type = 'bandpass';
            bpFilter.frequency.value = 2200 - size * 1600 + Math.random() * 400;
            bpFilter.Q.value = 0.5 + (1 - size) * 1.0;

            const noiseGain = audioCtx.createGain();
            noiseGain.gain.setValueAtTime(noiseVol, now);
            noiseGain.gain.exponentialRampToValueAtTime(0.001, now + noiseDur);

            noise.connect(bpFilter);
            bpFilter.connect(noiseGain);
            noiseGain.connect(audioCtx.destination);
            noise.start(now);
            noise.stop(now + noiseDur);

            // Low thump — dominant for large, subtle for small
            const thumpFreq = 80 + (1 - size) * 180 + Math.random() * 40;
            const thumpEnd = 20 + (1 - size) * 40;
            const thumpDur = 0.1 + size * 0.25;
            const thumpVol = 0.03 + size * 0.14;
            const osc = audioCtx.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(thumpFreq, now);
            osc.frequency.exponentialRampToValueAtTime(thumpEnd, now + thumpDur);
            const oscGain = audioCtx.createGain();
            oscGain.gain.setValueAtTime(thumpVol, now);
            oscGain.gain.exponentialRampToValueAtTime(0.001, now + thumpDur);
            osc.connect(oscGain);
            oscGain.connect(audioCtx.destination);
            osc.start(now);
            osc.stop(now + thumpDur);

            // Crackle pop — dominant for small, faint for large
            const popFreq = 2000 + (1 - size) * 3000 + Math.random() * 1000;
            const popDur = 0.04 + (1 - size) * 0.08;
            const popVol = 0.02 + (1 - size) * 0.06;
            const pop = audioCtx.createOscillator();
            pop.type = 'square';
            pop.frequency.setValueAtTime(popFreq, now);
            pop.frequency.exponentialRampToValueAtTime(400 + size * 200, now + popDur);
            const popGain = audioCtx.createGain();
            popGain.gain.setValueAtTime(popVol, now);
            popGain.gain.exponentialRampToValueAtTime(0.001, now + popDur);
            pop.connect(popGain);
            popGain.connect(audioCtx.destination);
            pop.start(now);
            pop.stop(now + popDur);

            // Large explosions get a secondary rumble
            if (size > 0.6) {
                const rumble = audioCtx.createOscillator();
                rumble.type = 'triangle';
                rumble.frequency.setValueAtTime(50 + Math.random() * 20, now + 0.05);
                rumble.frequency.exponentialRampToValueAtTime(25, now + 0.4);
                const rumbleGain = audioCtx.createGain();
                rumbleGain.gain.setValueAtTime(0.06 * size, now + 0.05);
                rumbleGain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                rumble.connect(rumbleGain);
                rumbleGain.connect(audioCtx.destination);
                rumble.start(now + 0.05);
                rumble.stop(now + 0.4);
            }

            // Small explosions get extra high crackle pops
            if (size < 0.35) {
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        if (!soundEnabled || !audioCtx) return;
                        const t = audioCtx.currentTime;
                        const p = audioCtx.createOscillator();
                        p.type = 'square';
                        p.frequency.setValueAtTime(4000 + Math.random() * 2000, t);
                        p.frequency.exponentialRampToValueAtTime(1000, t + 0.03);
                        const g = audioCtx.createGain();
                        g.gain.setValueAtTime(0.03, t);
                        g.gain.exponentialRampToValueAtTime(0.001, t + 0.03);
                        p.connect(g);
                        g.connect(audioCtx.destination);
                        p.start(t);
                        p.stop(t + 0.03);
                    }, 40 + Math.random() * 100);
                }
            }
        }

        function playIceCrack() {
            playTone(1800, 0.08, 'square', 0.06);
            setTimeout(() => playTone(2400, 0.06, 'square', 0.04), 30);
            setTimeout(() => playTone(1200, 0.1, 'triangle', 0.05), 60);
        }

        function playUncheck() {
            playTone(600, 0.1, 'sine', 0.06);
        }

        function playBingoChime() {
            const notes = [523, 659, 784, 1047];
            notes.forEach((f, i) => setTimeout(() => playTone(f, 0.3, 'sine', 0.12), i * 100));
        }

        function playMilestoneChime() {
            playTone(784, 0.15, 'sine', 0.1);
            setTimeout(() => playTone(988, 0.2, 'sine', 0.1), 80);
        }

        document.getElementById('soundToggle').addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            localStorage.setItem('ib_sound', soundEnabled ? 'on' : 'off');
            const btn = document.getElementById('soundToggle');
            btn.classList.toggle('active', soundEnabled);
            btn.classList.remove('hint-pulse');
            if (soundEnabled && audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        });

        // Respect prefers-reduced-motion
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            soundEnabled = false;
        }

        // Apply persisted sound state to UI
        {
            const btn = document.getElementById('soundToggle');
            if (soundEnabled) {
                btn.classList.add('active');
                btn.classList.remove('hint-pulse');
            } else if (storedSound !== null) {
                // User has toggled before, don't show hint pulse
                btn.classList.remove('hint-pulse');
            }
        }

        // ─── Visual Theme Config ───
        const visualThemes = {
            classic: {
                symbols: ['\u2744', '\u2745', '\u2746', '\u2744', '\u2745', '\u2746', '\u2744', '\u2745', '\u2746', '\u2744', '\u2745', '\u2746', '\u2744', '\u2745', '\u2746', '\u2744', '\u2745', '\u2746', '\u2744', '\u2745', '\u2746', '\u2744', '\u2728', '\u2B50', '\u2728', '\u2B50'],
                colors: [
                    ['rgba(255,255,255,0.35)','rgba(200,230,255,0.30)','rgba(255,255,255,0.28)','rgba(200,230,255,0.32)','rgba(255,255,255,0.30)'],
                    ['rgba(255,255,255,0.25)','rgba(186,220,248,0.22)','rgba(255,255,255,0.20)','rgba(200,230,255,0.24)','rgba(255,255,255,0.22)','rgba(186,220,248,0.26)','rgba(255,255,255,0.20)','rgba(200,230,255,0.23)'],
                    ['rgba(255,255,255,0.14)','rgba(255,255,255,0.12)','rgba(200,230,255,0.16)','rgba(255,255,255,0.13)','rgba(255,255,255,0.15)','rgba(200,230,255,0.14)','rgba(255,255,255,0.12)','rgba(255,255,255,0.16)','rgba(200,230,255,0.13)'],
                    ['rgba(56,189,248,0.20)','rgba(139,92,246,0.18)','rgba(56,189,248,0.22)','rgba(167,139,250,0.18)']
                ],
                starGrad: ['#fde68a','#f59e0b','#b45309'],
                starDrop: 'rgba(120,53,15,0.5)'
            },
            work: {
                symbols: ['\u25C6', '\u25A0', '\u25CF', '\u25B2', '\u25C7', '\u25C6', '\u25A0', '\u25CF', '\u25B2', '\u25C7', '\u25C6', '\u25A0', '\u25CF', '\u25C7', '\u25A0', '\u25CF', '\u25B2', '\u25C6', '\u25C7', '\u25A0', '\u25CF', '\u25B2', '\u2726', '\u2605', '\u2726', '\u2605'],
                colors: [
                    ['rgba(251,191,36,0.30)','rgba(148,163,184,0.25)','rgba(251,146,60,0.28)','rgba(148,163,184,0.30)','rgba(251,191,36,0.25)'],
                    ['rgba(251,191,36,0.20)','rgba(148,163,184,0.18)','rgba(251,146,60,0.16)','rgba(148,163,184,0.20)','rgba(251,191,36,0.18)','rgba(148,163,184,0.22)','rgba(251,146,60,0.16)','rgba(148,163,184,0.18)'],
                    ['rgba(251,191,36,0.12)','rgba(148,163,184,0.10)','rgba(251,146,60,0.12)','rgba(148,163,184,0.11)','rgba(251,191,36,0.10)','rgba(148,163,184,0.12)','rgba(251,146,60,0.10)','rgba(251,191,36,0.12)','rgba(148,163,184,0.10)'],
                    ['rgba(251,191,36,0.20)','rgba(251,146,60,0.18)','rgba(251,191,36,0.22)','rgba(148,163,184,0.18)']
                ],
                starGrad: ['#fde68a','#f59e0b','#92400e'],
                starDrop: 'rgba(120,53,15,0.5)'
            },
            friends: {
                symbols: ['\u2022', '\u25E6', '\u2726', '\u2727', '\u2022', '\u25E6', '\u2726', '\u2727', '\u2022', '\u25E6', '\u2726', '\u2727', '\u2022', '\u25E6', '\u2726', '\u2727', '\u2022', '\u25E6', '\u2726', '\u2727', '\u2022', '\u25E6', '\u2726', '\u2727', '\u2022', '\u25E6'],
                colors: [
                    ['rgba(168,162,148,0.30)','rgba(120,140,120,0.28)','rgba(200,170,120,0.28)','rgba(148,142,130,0.30)','rgba(140,160,140,0.28)'],
                    ['rgba(168,162,148,0.20)','rgba(120,140,120,0.18)','rgba(200,170,120,0.18)','rgba(148,142,130,0.20)','rgba(140,160,140,0.18)','rgba(168,162,148,0.20)','rgba(200,170,120,0.18)','rgba(120,140,120,0.20)'],
                    ['rgba(168,162,148,0.10)','rgba(120,140,120,0.10)','rgba(200,170,120,0.10)','rgba(148,142,130,0.10)','rgba(140,160,140,0.10)','rgba(168,162,148,0.10)','rgba(200,170,120,0.10)','rgba(120,140,120,0.10)','rgba(148,142,130,0.10)'],
                    ['rgba(168,162,148,0.20)','rgba(200,170,120,0.20)','rgba(120,140,120,0.20)','rgba(148,142,130,0.20)']
                ],
                starGrad: ['#d4c8a8','#b8963c','#8a7030'],
                starDrop: 'rgba(110,88,40,0.5)'
            },
            family: {
                symbols: ['\u2665', '\u2605', '\u263A', '\u2665', '\u2605', '\u2665', '\u263A', '\u2605', '\u2665', '\u2605', '\u2665', '\u263A', '\u2605', '\u2665', '\u2605', '\u263A', '\u2665', '\u2605', '\u2665', '\u263A', '\u2605', '\u2665', '\u2728', '\u2B50', '\u2728', '\u2B50'],
                colors: [
                    ['rgba(59,130,246,0.32)','rgba(234,179,8,0.30)','rgba(34,197,94,0.28)','rgba(59,130,246,0.30)','rgba(234,179,8,0.28)'],
                    ['rgba(59,130,246,0.22)','rgba(234,179,8,0.20)','rgba(34,197,94,0.18)','rgba(59,130,246,0.20)','rgba(234,179,8,0.18)','rgba(34,197,94,0.22)','rgba(59,130,246,0.20)','rgba(234,179,8,0.18)'],
                    ['rgba(59,130,246,0.12)','rgba(234,179,8,0.10)','rgba(34,197,94,0.12)','rgba(59,130,246,0.11)','rgba(234,179,8,0.10)','rgba(34,197,94,0.12)','rgba(59,130,246,0.10)','rgba(234,179,8,0.12)','rgba(34,197,94,0.10)'],
                    ['rgba(59,130,246,0.22)','rgba(234,179,8,0.20)','rgba(34,197,94,0.22)','rgba(59,130,246,0.20)']
                ],
                starGrad: ['#fde68a','#eab308','#a16207'],
                starDrop: 'rgba(133,77,14,0.5)'
            },
            dating: {
                symbols: ['\u2661', '\u2728', '\u2605', '\u2661', '\u2728', '\u2661', '\u2728', '\u2605', '\u2661', '\u2728', '\u2661', '\u2605', '\u2728', '\u2661', '\u2728', '\u2605', '\u2661', '\u2728', '\u2661', '\u2605', '\u2728', '\u2661', '\u2728', '\u2B50', '\u2728', '\u2B50'],
                colors: [
                    ['rgba(244,114,182,0.32)','rgba(232,121,249,0.28)','rgba(251,191,36,0.25)','rgba(244,114,182,0.30)','rgba(232,121,249,0.28)'],
                    ['rgba(244,114,182,0.22)','rgba(232,121,249,0.20)','rgba(251,191,36,0.16)','rgba(244,114,182,0.20)','rgba(232,121,249,0.18)','rgba(244,114,182,0.22)','rgba(251,191,36,0.16)','rgba(232,121,249,0.18)'],
                    ['rgba(244,114,182,0.12)','rgba(232,121,249,0.10)','rgba(251,191,36,0.10)','rgba(244,114,182,0.11)','rgba(232,121,249,0.10)','rgba(244,114,182,0.12)','rgba(251,191,36,0.10)','rgba(244,114,182,0.12)','rgba(232,121,249,0.10)'],
                    ['rgba(244,114,182,0.22)','rgba(232,121,249,0.20)','rgba(251,191,36,0.18)','rgba(244,114,182,0.20)']
                ],
                starGrad: ['#fecdd3','#f472b6','#db2777'],
                starDrop: 'rgba(157,23,77,0.5)'
            }
        };

        // Particle layer layout (matches the original snowflake structure)
        const particleLayout = [
            // Layer 1: large foreground (5)
            { left: '3%',  size: '1.8rem', fall: 14, sway: 4,  delay: 0,  swayD: 0 },
            { left: '22%', size: '1.6rem', fall: 16, sway: 5,  delay: 2,  swayD: 1 },
            { left: '48%', size: '2.0rem', fall: 13, sway: 3.5,delay: 5,  swayD: 0.5 },
            { left: '70%', size: '1.7rem', fall: 15, sway: 4.5,delay: 1,  swayD: 2 },
            { left: '90%', size: '1.5rem', fall: 17, sway: 5.5,delay: 8,  swayD: 0 },
            // Layer 2: medium mid-ground (8)
            { left: '8%',  size: '1.1rem', fall: 20, sway: 5,  delay: 3,  swayD: 1.5 },
            { left: '18%', size: '1.3rem', fall: 18, sway: 6,  delay: 0,  swayD: 3 },
            { left: '32%', size: '1.0rem', fall: 22, sway: 4.5,delay: 6,  swayD: 0 },
            { left: '45%', size: '1.2rem', fall: 19, sway: 5.5,delay: 10, swayD: 2 },
            { left: '58%', size: '1.1rem', fall: 21, sway: 6.5,delay: 4,  swayD: 1 },
            { left: '72%', size: '1.4rem', fall: 17, sway: 4,  delay: 7,  swayD: 0.5 },
            { left: '83%', size: '1.0rem', fall: 23, sway: 5,  delay: 1,  swayD: 2.5 },
            { left: '95%', size: '1.3rem', fall: 20, sway: 5.5,delay: 9,  swayD: 0 },
            // Layer 3: small background (9)
            { left: '6%',  size: '0.6rem', fall: 12, sway: 3,  delay: 2,  swayD: 0,   blur: 1 },
            { left: '14%', size: '0.5rem', fall: 10, sway: 3.5,delay: 0,  swayD: 1,   blur: 1 },
            { left: '25%', size: '0.7rem', fall: 11, sway: 2.5,delay: 4,  swayD: 0.5, blur: 1 },
            { left: '38%', size: '0.5rem', fall: 13, sway: 4,  delay: 6,  swayD: 2,   blur: 1.5 },
            { left: '52%', size: '0.6rem', fall: 9,  sway: 3,  delay: 1,  swayD: 0,   blur: 1 },
            { left: '63%', size: '0.7rem', fall: 12, sway: 3.5,delay: 8,  swayD: 1.5, blur: 1 },
            { left: '76%', size: '0.5rem', fall: 10, sway: 2.5,delay: 3,  swayD: 0,   blur: 1.5 },
            { left: '85%', size: '0.6rem', fall: 11, sway: 4,  delay: 5,  swayD: 1,   blur: 1 },
            { left: '96%', size: '0.5rem', fall: 14, sway: 3,  delay: 7,  swayD: 2.5, blur: 1 },
            // Layer 4: sparkles (4)
            { left: '10%', size: '0.9rem', fall: 16, sway: 5,  delay: 0,  swayD: 0.5, sparkle: 2 },
            { left: '40%', size: '0.8rem', fall: 19, sway: 4,  delay: 3,  swayD: 1,   sparkle: 2.5 },
            { left: '65%', size: '1.0rem', fall: 14, sway: 5.5,delay: 6,  swayD: 0,   sparkle: 1.8 },
            { left: '88%', size: '0.7rem', fall: 21, sway: 4.5,delay: 9,  swayD: 2,   sparkle: 2.2 }
        ];

        function buildParticles(themeKey) {
            const container = document.getElementById('particleContainer');
            container.innerHTML = '';
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

            const cfg = visualThemes[themeKey] || visualThemes.classic;
            const allColors = [...cfg.colors[0], ...cfg.colors[1], ...cfg.colors[2], ...cfg.colors[3]];

            particleLayout.forEach((p, i) => {
                const el = document.createElement('div');
                el.className = 'snowflake';
                el.textContent = cfg.symbols[i] || cfg.symbols[0];
                el.style.left = p.left;
                el.style.fontSize = p.size;
                el.style.color = allColors[i] || allColors[0];
                if (p.blur) el.style.filter = `blur(${p.blur}px)`;

                if (p.sparkle) {
                    el.style.animation = `snowfall ${p.fall}s linear infinite, snowsway ${p.sway}s ease-in-out infinite, sparkle ${p.sparkle}s ease-in-out infinite`;
                    el.style.animationDelay = `${p.delay}s, ${p.swayD}s, 0s`;
                } else {
                    el.style.animationDuration = `${p.fall}s, ${p.sway}s`;
                    el.style.animationDelay = `${p.delay}s, ${p.swayD}s`;
                }
                container.appendChild(el);
            });
        }

        function applyVisualTheme(themeKey) {
            document.body.dataset.visualTheme = themeKey;
            buildParticles(themeKey);
        }

        // ─── Theme Picker ───
        function buildThemePicker() {
            const picker = document.getElementById('themePicker');
            picker.innerHTML = '';
            for (const [key, theme] of Object.entries(themes)) {
                const btn = document.createElement('button');
                btn.className = 'theme-btn' + (key === currentTheme ? ' active' : '');
                btn.textContent = theme.name;
                btn.dataset.theme = key;
                btn.addEventListener('click', () => selectTheme(key));
                picker.appendChild(btn);
            }
            // Daily challenge button
            const dailyBtn = document.createElement('button');
            dailyBtn.className = 'theme-btn' + (isDailyMode ? ' active' : '');
            dailyBtn.innerHTML = 'Daily<span class="daily-badge">NEW</span>';
            dailyBtn.id = 'dailyBtn';
            dailyBtn.addEventListener('click', toggleDailyMode);
            picker.appendChild(dailyBtn);
        }

        function selectTheme(key) {
            if (isDailyMode) {
                isDailyMode = false;
                localStorage.setItem('ib_daily', 'false');
            }
            currentTheme = key;
            localStorage.setItem('ib_theme', key);
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.theme-btn[data-theme="${key}"]`)?.classList.add('active');
            document.getElementById('dailyBtn')?.classList.remove('active');
            document.getElementById('resetBtn').disabled = false;
            applyVisualTheme(key);
            resetBoard();
        }

        function toggleDailyMode() {
            isDailyMode = !isDailyMode;
            localStorage.setItem('ib_daily', isDailyMode ? 'true' : 'false');
            document.getElementById('dailyBtn')?.classList.toggle('active', isDailyMode);
            if (isDailyMode) {
                document.querySelectorAll('.theme-btn[data-theme]').forEach(b => b.classList.remove('active'));
                document.getElementById('resetBtn').disabled = true;
            } else {
                document.querySelector(`.theme-btn[data-theme="${currentTheme}"]`)?.classList.add('active');
                document.getElementById('resetBtn').disabled = false;
            }
            resetBoard();
        }

        // ─── Daily Board ───
        function getDailySeed() {
            const today = new Date().toISOString().slice(0, 10);
            return hashString(today + '_' + currentTheme);
        }

        function loadDailyProgress() {
            const today = new Date().toISOString().slice(0, 10);
            const key = `ib_daily_${today}_${currentTheme}`;
            const saved = localStorage.getItem(key);
            if (saved) {
                try {
                    const arr = JSON.parse(saved);
                    arr.forEach((v, i) => { cells[i] = v; });
                    return true;
                } catch (e) { /* ignore */ }
            }
            return false;
        }

        function saveDailyProgress() {
            if (!isDailyMode) return;
            const today = new Date().toISOString().slice(0, 10);
            const key = `ib_daily_${today}_${currentTheme}`;
            localStorage.setItem(key, JSON.stringify(cells));
        }

        // ─── Board Setup ───
        function getPrompts() {
            return themes[currentTheme]?.prompts || themes.classic.prompts;
        }

        function initBoard() {
            const prompts = getPrompts();
            if (isDailyMode) {
                currentSeed = getDailySeed();
                shuffled = shuffleArray(prompts, currentSeed).slice(0, 24);
            } else if (currentSeed !== null && !isDailyMode) {
                // Challenge link mode
                shuffled = shuffleArray(prompts, currentSeed).slice(0, 24);
            } else {
                currentSeed = Math.floor(Math.random() * 2147483646) + 1;
                shuffled = shuffleArray(prompts, currentSeed).slice(0, 24);
            }
        }

        function createGrid() {
            let index = 0;
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const cell = document.createElement('label');
                    cell.className = 'grid-cell';
                    cell.setAttribute('role', 'gridcell');

                    if (row === 2 && col === 2) {
                        cell.classList.add('center-cell');
                        const sg = (visualThemes[currentTheme] || visualThemes.classic).starGrad;
                        const sd = (visualThemes[currentTheme] || visualThemes.classic).starDrop;
                        cell.innerHTML = `
                            <svg class="star-3d" viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="filter: drop-shadow(0 3px 4px ${sd})">
                                <defs>
                                    <linearGradient id="goldGradient" x1="0" y1="0" x2="1" y2="1">
                                        <stop offset="0%" stop-color="${sg[0]}"/>
                                        <stop offset="40%" stop-color="${sg[1]}"/>
                                        <stop offset="100%" stop-color="${sg[2]}"/>
                                    </linearGradient>
                                    <linearGradient id="goldHighlight" x1="0" y1="0" x2="0.5" y2="1">
                                        <stop offset="0%" stop-color="#ffffff"/>
                                        <stop offset="100%" stop-color="#ffffff" stop-opacity="0"/>
                                    </linearGradient>
                                </defs>
                                <path class="star-base" d="M12 17.27L18.18 21L16.54 13.97L22 9.24L14.81 8.63L12 2L9.19 8.63L2 9.24L7.46 13.97L5.82 21L12 17.27Z"/>
                                <path class="star-highlight" d="M12 2L14.81 8.63L22 9.24L16.54 13.97L18.18 21L12 17.27L5.82 21L7.46 13.97L2 9.24L9.19 8.63L12 2Z" clip-path="polygon(0 0, 100% 0, 40% 60%)"/>
                            </svg>
                        `;
                        cell.setAttribute('aria-label', 'Free space, always checked');
                        cells[row * 5 + col] = true;
                    } else {
                        const promptText = shuffled[index];
                        const isChecked = cells[row * 5 + col];
                        cell.innerHTML = `
                            <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleCell(${row}, ${col})" aria-label="${promptText}">
                            <span>${promptText}</span>
                        `;
                        index++;
                    }
                    grid.appendChild(cell);
                }
            }
            updateStats();
            // Re-check wins for restored daily boards
            if (isDailyMode) {
                for (const [pi, pattern] of winningPatterns.entries()) {
                    if (pattern.every(i => cells[i]) && !completedPatterns.has(pi)) {
                        completedPatterns.add(pi);
                        wins++;
                    }
                }
                document.getElementById('winsCount').textContent = wins;
            }
        }

        function toggleCell(row, col) {
            const index = row * 5 + col;
            cells[index] = !cells[index];
            if (cells[index]) {
                playIceCrack();
                spawnIceShards(index);
            } else {
                playUncheck();
                // Reset blackout if a tile is deselected
                if (blackoutTriggered) {
                    blackoutTriggered = false;
                }
            }
            updateStats();
            if (cells[index]) {
                checkWins();
                checkBlackout();
            } else {
                reconcileWins();
            }
            saveDailyProgress();
        }

        /** Burst ice shard particles outward from a cell */
        function spawnIceShards(cellIndex) {
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
            const cellEl = grid.children[cellIndex];
            if (!cellEl) return;
            const rect = cellEl.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const shardCount = 10;
            for (let i = 0; i < shardCount; i++) {
                const shard = document.createElement('div');
                shard.className = 'ice-shard';
                shard.setAttribute('aria-hidden', 'true');
                const angle = (i / shardCount) * 360 + (Math.random() * 30 - 15);
                const distance = 35 + Math.random() * 55;
                const rad = angle * Math.PI / 180;
                const size = 5 + Math.random() * 9;
                shard.style.left = (cx - size / 2) + 'px';
                shard.style.top = (cy - size / 2) + 'px';
                shard.style.width = size + 'px';
                shard.style.height = (size * 1.3) + 'px';
                shard.style.setProperty('--shard-dx', (Math.cos(rad) * distance) + 'px');
                shard.style.setProperty('--shard-dy', (Math.sin(rad) * distance) + 'px');
                shard.style.setProperty('--shard-rot', (Math.random() * 540 - 270) + 'deg');
                shard.style.animationDelay = (Math.random() * 0.08) + 's';
                document.body.appendChild(shard);
                shard.addEventListener('animationend', () => shard.remove());
            }
        }

        function updateStats() {
            const checked = cells.filter((v, i) => v && i !== 12).length;
            document.getElementById('checkedCount').textContent = checked;

            // Update personality title — show as achievement toast
            const newTitle = getTitle(checked);
            if (newTitle !== currentTitle) {
                const wasEmpty = currentTitle === '';
                currentTitle = newTitle;
                if (!suppressTitleToast && !wasEmpty) {
                    showAchievementToast(currentTitle);
                }
            }

            // Milestone confetti
            const milestones = [10, 15, 20];
            // Reset milestones that are no longer met
            for (const m of [...hitMilestones]) {
                if (checked < m) hitMilestones.delete(m);
            }
            for (const m of milestones) {
                if (checked >= m && !hitMilestones.has(m)) {
                    hitMilestones.add(m);
                    playMilestoneChime();
                    createParticles(20);
                    const msgs = { 10: '10 down! Keep going!', 15: '15! You\'re on fire!', 20: '20! Almost there!' };
                    showToast('\u2728', msgs[m], 2500);
                }
            }
        }

        function reconcileWins() {
            // Remove patterns that are no longer complete (tile was deselected)
            for (const pi of [...completedPatterns]) {
                if (!winningPatterns[pi].every(i => cells[i])) {
                    completedPatterns.delete(pi);
                    wins = Math.max(0, wins - 1);
                }
            }
            document.getElementById('winsCount').textContent = wins;
        }

        function checkWins() {
            // Check for newly completed patterns
            for (const [patternIndex, pattern] of winningPatterns.entries()) {
                if (pattern.every(i => cells[i]) && !completedPatterns.has(patternIndex)) {
                    completedPatterns.add(patternIndex);
                    wins++;
                    // Update best streak in localStorage
                    const best = parseInt(localStorage.getItem('ib_bestBingos') || '0', 10);
                    if (wins > best) localStorage.setItem('ib_bestBingos', wins);

                    document.getElementById('winsCount').textContent = wins;
                    playBingoChime();
                    showOverlay();
                    createParticles(50);
                    break;
                }
            }
        }

        let blackoutTriggered = false;

        function checkBlackout() {
            if (blackoutTriggered) return;
            if (cells.every(Boolean)) {
                blackoutTriggered = true;
                // Close the normal bingo overlay if it's showing
                const overlay = document.getElementById('overlay');
                if (overlay.classList.contains('active')) {
                    overlay.classList.remove('active');
                    clearParticles();
                }
                // Short delay so the last bingo settles, then show blackout
                setTimeout(() => showBlackoutCelebration(), 300);
            }
        }

        function playBlackoutFanfare() {
            const notes = [523, 659, 784, 880, 1047, 1175, 1319, 1568];
            notes.forEach((f, i) => setTimeout(() => playTone(f, 0.4, 'sine', 0.14), i * 90));
            // Final chord
            setTimeout(() => {
                playTone(1047, 0.6, 'sine', 0.12);
                playTone(1319, 0.6, 'sine', 0.10);
                playTone(1568, 0.8, 'sine', 0.10);
            }, notes.length * 90);
        }

        let fireworksActive = false;

        function launchFireworks() {
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
            fireworksActive = true;
            const colors = [
                ['#fbbf24', '#f59e0b', '#fde68a', '#fcd34d'],
                ['#38bdf8', '#67e8f9', '#818cf8', '#a5f3fc'],
                ['#f0abfc', '#e879f9', '#d946ef', '#f5d0fe'],
                ['#34d399', '#6ee7b7', '#a7f3d0', '#5eead4'],
                ['#fb7185', '#f43f5e', '#fda4af', '#fecdd3'],
                ['#fbbf24', '#fb923c', '#fde68a', '#fdba74'],
            ];

            function makeSpark(burst, angle, dist, color, dur, cls) {
                const spark = document.createElement('div');
                spark.className = `firework-spark ${cls}`;
                spark.style.background = color;
                spark.style.boxShadow = `0 0 10px ${color}, 0 0 24px ${color}`;
                spark.style.setProperty('--fw-x', `${Math.cos(angle) * dist}px`);
                spark.style.setProperty('--fw-y', `${Math.sin(angle) * dist + dist * 0.25}px`);
                spark.style.setProperty('--fw-duration', `${dur}s`);
                spark.style.animationDelay = `${Math.random() * 0.06}s`;
                burst.appendChild(spark);
            }

            function spawnBurst() {
                if (!fireworksActive) return;
                const palette = colors[Math.floor(Math.random() * colors.length)];
                const burstX = 10 + Math.random() * 80;
                const burstY = 12 + Math.random() * 45;

                // Random size: 0 = small, 0.5 = medium, 1 = large
                const size = Math.random();
                const baseRadius = 50 + size * 180;
                const burstDuration = 0.9 + size * 0.8;

                // Trail rising from bottom — bigger trail for bigger fireworks
                const trailSize = 2 + size * 4;
                const trail = document.createElement('div');
                trail.className = 'firework-trail';
                trail.setAttribute('aria-hidden', 'true');
                trail.style.left = `${burstX}vw`;
                trail.style.bottom = '0';
                trail.style.width = `${trailSize}px`;
                trail.style.height = `${trailSize}px`;
                trail.style.background = palette[0];
                trail.style.boxShadow = `0 0 ${4 + size * 12}px ${palette[0]}, 0 0 ${8 + size * 16}px ${palette[0]}`;
                const riseDistance = (100 - burstY);
                trail.style.setProperty('--trail-duration', `${0.35 + Math.random() * 0.2}s`);
                trail.style.setProperty('--trail-target-y', `-${riseDistance}vh`);
                const overlay = document.getElementById('overlay');
                overlay.appendChild(trail);

                const trailTime = parseFloat(trail.style.getPropertyValue('--trail-duration')) * 1000;
                setTimeout(() => {
                    trail.remove();
                    const burst = document.createElement('div');
                    burst.className = 'firework-burst';
                    burst.setAttribute('aria-hidden', 'true');
                    burst.style.left = `${burstX}vw`;
                    burst.style.top = `${burstY}vh`;
                    overlay.appendChild(burst);

                    playFireworkBoom(size);

                    // Central flash — scales with size
                    const flash = document.createElement('div');
                    flash.className = 'firework-flash';
                    const flashScale = 0.5 + size * 1.0;
                    flash.style.width = `${30 * flashScale}px`;
                    flash.style.height = `${30 * flashScale}px`;
                    flash.style.background = `radial-gradient(circle, ${palette[3] || palette[0]}, transparent)`;
                    burst.appendChild(flash);

                    // Inner ring – spark count scales with size
                    const innerCount = Math.floor(10 + size * 22 + Math.random() * 8);
                    for (let i = 0; i < innerCount; i++) {
                        const angle = (Math.PI * 2 * i) / innerCount + (Math.random() - 0.5) * 0.2;
                        const dist = baseRadius * (0.4 + Math.random() * 0.25);
                        const color = palette[Math.floor(Math.random() * palette.length)];
                        makeSpark(burst, angle, dist, color, burstDuration * 0.85, 'spark-core');
                    }

                    // Outer ring – more sparks for bigger fireworks
                    const outerCount = Math.floor(14 + size * 30 + Math.random() * 10);
                    for (let i = 0; i < outerCount; i++) {
                        const angle = (Math.PI * 2 * i) / outerCount + (Math.random() - 0.5) * 0.25;
                        const dist = baseRadius * (0.8 + Math.random() * 0.3);
                        const color = palette[Math.floor(Math.random() * palette.length)];
                        makeSpark(burst, angle, dist, color, burstDuration, 'spark-outer');
                    }

                    // Crackle sparks – delayed secondary pops
                    const crackleCount = Math.floor(6 + size * 18 + Math.random() * 8);
                    setTimeout(() => {
                        for (let i = 0; i < crackleCount; i++) {
                            const angle = Math.random() * Math.PI * 2;
                            const origin = baseRadius * (0.3 + Math.random() * 0.5);
                            const dist = 20 + Math.random() * 40;
                            const color = palette[Math.floor(Math.random() * palette.length)];
                            const spark = document.createElement('div');
                            spark.className = 'firework-spark spark-crackle';
                            spark.style.background = color;
                            spark.style.boxShadow = `0 0 6px ${color}, 0 0 14px ${color}`;
                            const ox = Math.cos(angle) * origin;
                            const oy = Math.sin(angle) * origin;
                            spark.style.left = `${ox}px`;
                            spark.style.top = `${oy}px`;
                            const subAngle = angle + (Math.random() - 0.5) * 1.5;
                            spark.style.setProperty('--fw-x', `${Math.cos(subAngle) * dist}px`);
                            spark.style.setProperty('--fw-y', `${Math.sin(subAngle) * dist + 15}px`);
                            spark.style.setProperty('--fw-duration', `${0.5 + Math.random() * 0.3}s`);
                            burst.appendChild(spark);
                        }
                    }, burstDuration * 400);

                    // Clean up
                    setTimeout(() => burst.remove(), burstDuration * 1000 + 800);
                }, trailTime);

                setTimeout(spawnBurst, 300 + Math.random() * 600);
            }

            spawnBurst();
        }

        function createRaySparkles() {
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
            const overlay = document.getElementById('overlay');
            const container = document.createElement('div');
            container.className = 'ray-sparkles';
            container.setAttribute('aria-hidden', 'true');

            // Center angles of each ray (matching conic-gradient)
            const rayAngles = [4, 26.5, 49, 71.5, 94, 116.5, 139, 161.5,
                               184, 206.5, 229, 251.5, 274, 296.5, 319, 341.5];
            const rayHalfWidth = 4; // degrees from center to edge
            const colors = ['#ffffff', '#fde68a', '#fbbf24', '#fef9c3', '#f59e0b'];

            rayAngles.forEach(center => {
                const sparkleCount = 12 + Math.floor(Math.random() * 6);
                for (let i = 0; i < sparkleCount; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'ray-sparkle';
                    // Stay within the ray's angular width
                    const angleDeg = center + (Math.random() - 0.5) * rayHalfWidth * 2;
                    const angleRad = angleDeg * Math.PI / 180;
                    // Distribute along the ray's length (5% to 45% from center)
                    const dist = 5 + Math.random() * 40;
                    const x = 50 + Math.cos(angleRad) * dist;
                    const y = 50 + Math.sin(angleRad) * dist;
                    sparkle.style.left = `${x}%`;
                    sparkle.style.top = `${y}%`;

                    const size = 1.5 + Math.random() * 4;
                    sparkle.style.width = `${size}px`;
                    sparkle.style.height = `${size}px`;

                    const color = colors[Math.floor(Math.random() * colors.length)];
                    sparkle.style.background = color;
                    sparkle.style.boxShadow = `0 0 ${size + 2}px ${color}`;

                    sparkle.style.setProperty('--twinkle-dur', `${0.6 + Math.random() * 1.4}s`);
                    sparkle.style.setProperty('--twinkle-delay', `${Math.random() * 2}s`);

                    container.appendChild(sparkle);
                }
            });

            overlay.appendChild(container);
        }

        function clearRaySparkles() {
            document.querySelectorAll('.ray-sparkles').forEach(el => el.remove());
        }

        function showBlackoutCelebration() {
            playBlackoutFanfare();
            launchFireworks();

            // Update overlay content for blackout
            document.getElementById('overlayTitle').textContent = 'BLACKOUT!';
            document.querySelector('.overlay-card .trophy').innerHTML = '&#127775;';
            document.getElementById('overlayDesc').textContent =
                'Every single square! You are the ultimate icebreaker!';

            const overlay = document.getElementById('overlay');
            overlay.classList.add('active', 'blackout');
            createRaySparkles();
            announce('Blackout! Every single square checked!');
            const btn = document.getElementById('newBoardBtn');
            if (btn) btn.focus();
        }

        function showOverlay() {
            const overlay = document.getElementById('overlay');
            overlay.classList.add('active');
            announce('Bingo! You broke the ice!');
            const btn = document.getElementById('newBoardBtn');
            if (btn) btn.focus();
        }

        function closeOverlay() {
            const overlay = document.getElementById('overlay');
            const wasBlackout = overlay.classList.contains('blackout');
            overlay.classList.remove('active', 'blackout');
            fireworksActive = false;
            clearParticles();
            clearRaySparkles();
            // Restore normal bingo overlay text
            if (wasBlackout) {
                document.getElementById('overlayTitle').textContent = 'Bingo!';
                document.querySelector('.overlay-card .trophy').innerHTML = '&#127881;';
                document.getElementById('overlayDesc').textContent =
                    'You broke the ice! Spread the fun \u2014 share your board.';
            }
            document.getElementById('bingo-game').focus();
        }

        function announce(message) {
            const el = document.getElementById('srAnnounce');
            el.textContent = '';
            requestAnimationFrame(() => { el.textContent = message; });
        }

        function createParticles(count = 50) {
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
            const shapes = ['&#10052;', '&#10053;', '&#10054;', '&#10040;', '&#9733;'];
            const colors = ['#38bdf8', '#818cf8', '#a78bfa', '#67e8f9', '#f0abfc', '#fbbf24'];
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.setAttribute('aria-hidden', 'true');
                particle.innerHTML = shapes[Math.floor(Math.random() * shapes.length)];
                particle.style.left = `${Math.random() * 100}vw`;
                particle.style.color = colors[Math.floor(Math.random() * colors.length)];
                particle.style.fontSize = `${Math.random() * 14 + 10}px`;
                particle.style.animationDuration = `${Math.random() * 3 + 2}s`;
                particle.style.animationDelay = `${Math.random() * 2}s`;
                document.body.appendChild(particle);
            }
        }

        function clearParticles() {
            document.querySelectorAll('.particle, .firework-burst, .firework-trail, .firework-flash').forEach(p => p.remove());
        }

        // Close overlay on background click
        document.getElementById('overlay').addEventListener('click', (e) => {
            if (e.target.id === 'overlay') closeOverlay();
        });

        // Escape key closes topmost overlay (WCAG 2.1.1)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const pasteCoach = document.getElementById('pasteCoach');
                if (pasteCoach.classList.contains('active')) {
                    dismissPasteCoach();
                    return;
                }
                const shareOverlay = document.getElementById('shareOverlay');
                if (shareOverlay.classList.contains('active')) {
                    closeSharePanel();
                    return;
                }
                const overlay = document.getElementById('overlay');
                if (overlay.classList.contains('active')) closeOverlay();
            }
        });

        // Focus trap inside overlay dialog (WCAG 2.4.3)
        document.getElementById('overlay').addEventListener('keydown', (e) => {
            if (e.key !== 'Tab') return;
            const overlay = document.getElementById('overlay');
            if (!overlay.classList.contains('active')) return;
            const focusable = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (focusable.length === 0) return;
            const first = focusable[0];
            const last = focusable[focusable.length - 1];
            if (e.shiftKey) {
                if (document.activeElement === first) { e.preventDefault(); last.focus(); }
            } else {
                if (document.activeElement === last) { e.preventDefault(); first.focus(); }
            }
        });

        document.getElementById('newBoardBtn').addEventListener('click', closeOverlay);
        document.getElementById('resetBtn').addEventListener('click', resetBoard);
        document.getElementById('shareBtn').addEventListener('click', shareBoard);
        document.getElementById('overlayShareBtn').addEventListener('click', shareBoard);

        function resetBoard() {
            clearParticles();
            hitMilestones.clear();
            cells.fill(false);
            completedPatterns.clear();
            blackoutTriggered = false;
            // Don't reset wins — persist across boards in session
            currentTitle = '';
            suppressTitleToast = true;
            currentSeed = isDailyMode ? getDailySeed() : null;
            initBoard();
            grid.innerHTML = '';
            if (isDailyMode) {
                loadDailyProgress();
            }
            createGrid();
            suppressTitleToast = false;
        }

        // ─── Challenge Link Support ───
        function getBoardUrl() {
            if (!currentSeed) return SHARE_URL;
            // Encode checked cells as a bitmask
            const bits = cells.map(c => c ? '1' : '0').join('');
            const packed = parseInt(bits, 2).toString(36);
            // Use path-based URL: /b/SEED.THEME.CELLS
            return `${SHARE_URL}/b/${currentSeed}.${currentTheme}.${packed}`;
        }

        function loadFromUrl() {
            let seed, theme, checkedParam;

            // Check for path stored by 404.html redirect (GitHub Pages)
            const redirectPath = sessionStorage.getItem('redirect_path');
            if (redirectPath) sessionStorage.removeItem('redirect_path');
            const pathToCheck = redirectPath || window.location.pathname;

            // Try path-based URL first: /b/SEED.THEME.CELLS
            const pathMatch = pathToCheck.match(/^\/b\/([^.]+)\.([^.]+)\.([^.]+)/);
            if (pathMatch) {
                seed = pathMatch[1];
                theme = pathMatch[2];
                checkedParam = pathMatch[3];
            } else {
                // Fall back to query params for backward compatibility
                const params = new URLSearchParams(window.location.search);
                seed = params.get('b');
                theme = params.get('t');
                checkedParam = params.get('c');
            }

            if (seed) {
                currentSeed = parseInt(seed, 10);
                if (theme && themes[theme]) {
                    currentTheme = theme;
                    applyVisualTheme(theme);
                }
                isDailyMode = false;
                localStorage.setItem('ib_daily', 'false');

                // Store challenger's checked cells for comparison
                if (checkedParam) {
                    const num = parseInt(checkedParam, 36);
                    const bits = num.toString(2).padStart(25, '0');
                    window._challengerCells = bits.split('').map(b => b === '1');
                }
                return true;
            }
            return false;
        }

        // ─── Comparison Mode ───
        function showComparison() {
            if (!window._challengerCells) return;
            const theirs = window._challengerCells;
            const both = [], onlyYou = [], onlyThem = [];

            for (let i = 0; i < 25; i++) {
                if (i === 12) continue; // free space
                const label = i < 12 ? shuffled[i] : shuffled[i - 1];
                if (cells[i] && theirs[i]) both.push(label);
                else if (cells[i] && !theirs[i]) onlyYou.push(label);
                else if (!cells[i] && theirs[i]) onlyThem.push(label);
            }

            // Highlight cells on the board
            const gridCells = grid.children;
            for (let i = 0; i < 25; i++) {
                const cell = gridCells[i];
                cell.style.outline = '';
                if (i === 12) continue;
                if (cells[i] && theirs[i]) {
                    cell.style.outline = '3px solid #34d399';
                } else if (!cells[i] && theirs[i]) {
                    cell.style.outline = '3px dashed #f59e0b';
                }
            }

            const msg = `You have ${both.length} thing${both.length !== 1 ? 's' : ''} in common!`;
            showToast('\u2728', msg, 5000);
            announce(msg);
        }

        // ─── Challenge Landing CTA ───
        function startOwnBoard() {
            // Exit challenge viewer mode
            const mainEl = document.getElementById('bingo-game');
            mainEl.classList.remove('challenge-viewer');

            // Reset cells
            for (let i = 0; i < 25; i++) cells[i] = false;
            cells[12] = true; // free space

            // Generate a fresh random board
            currentSeed = Math.floor(Math.random() * 2147483646) + 1;
            isDailyMode = false;
            initBoard();

            // Rebuild grid
            grid.innerHTML = '';
            createGrid();

            // Reset wins and patterns
            wins = 0;
            completedPatterns.clear();
            hitMilestones.clear();
            document.getElementById('winsCount').textContent = wins;

            // Restore header subtitle
            const headerSubtitle = document.querySelector('.header p');
            headerSubtitle.textContent = DEFAULT_SUBTITLE;

            // Clear challenger data and URL
            window._challengerCells = null;
            history.replaceState({}, '', '/');
        }

        // ─── Share Panel Logic ───

        function getShareText() {
            const checked = cells.filter((v, i) => v && i !== 12).length;
            const title = getTitle(checked);
            if (isDailyMode) {
                return `I'm a ${title} on today's Daily Icebreaker Bingo! How many squares can you check off?`;
            }
            return `I'm a ${title}! \uD83C\uDF89 How many squares can you check off? Try Icebreaker Bingo!`;
        }

        const SHARE_URL = 'https://icebreakerbingo.com';
        let currentImageBlob = null;

        let achToastTimeout = null;
        function showAchievementToast(title) {
            const toast = document.getElementById('achievementToast');
            const titleEl = document.getElementById('achTitle');
            titleEl.textContent = title;

            // Reset animation
            toast.classList.remove('show');
            clearTimeout(achToastTimeout);
            void toast.offsetWidth;
            toast.classList.add('show');

            achToastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3500);
        }

        function showToast(icon, message, duration = 3000) {
            const toast = document.getElementById('shareToast');
            toast.querySelector('.toast-icon').textContent = icon;
            toast.querySelector('.toast-message').textContent = message;
            toast.classList.add('show');
            clearTimeout(toast._timeout);
            toast._timeout = setTimeout(() => toast.classList.remove('show'), duration);
        }

        function openSharePanel() {
            const overlay = document.getElementById('shareOverlay');
            overlay.classList.add('active');
            overlay.setAttribute('aria-hidden', 'false');
            document.getElementById('sharePanelClose').focus();
        }

        function closeSharePanel() {
            const overlay = document.getElementById('shareOverlay');
            overlay.classList.remove('active');
            overlay.setAttribute('aria-hidden', 'true');
            const hint = document.getElementById('sharePanelHint');
            hint.classList.remove('has-image');
        }

        function setHintWave(el, text) {
            el.innerHTML = '';
            let charIndex = 0;
            for (let i = 0; i < text.length; i++) {
                const span = document.createElement('span');
                span.className = 'wave-char';
                if (text[i] === ' ') {
                    span.innerHTML = '&nbsp;';
                } else {
                    span.textContent = text[i];
                }
                span.style.animationDelay = (charIndex * 0.04) + 's';
                el.appendChild(span);
                charIndex++;
            }
        }

        async function copyImageToClipboard(blob) {
            try {
                const item = new ClipboardItem({ 'image/png': blob });
                await navigator.clipboard.write([item]);
                return true;
            } catch (err) {
                console.warn('Clipboard write failed:', err);
                return false;
            }
        }

        function downloadImage(blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'icebreaker-bingo.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function generateBoardImage() {
            const boardEl = document.querySelector('.board-frame');
            if (!boardEl || typeof html2canvas === 'undefined') return null;

            const wrapper = document.createElement('div');
            const bgDeep = getComputedStyle(document.body).getPropertyValue('--bg-deep').trim();
            const titleGlow = getComputedStyle(document.body).getPropertyValue('--title-glow').trim();

            wrapper.style.cssText = `
                position: fixed; left: -9999px; top: 0;
                background: ${bgDeep};
                padding: 32px 28px 24px;
                border-radius: 24px;
                display: flex; flex-direction: column; align-items: center; gap: 16px;
            `;

            const title = document.createElement('div');
            title.textContent = 'Icebreaker Bingo';
            title.style.cssText = `
                font-family: Fredoka, Inter, system-ui, sans-serif;
                font-size: 24px; font-weight: 700; color: #ffffff;
                text-shadow: 0 0 24px ${titleGlow};
                text-align: center;
            `;
            wrapper.appendChild(title);

            // Stats banner — styled scoreboard matching the on-site HUD
            const checked = cells.filter((v, i) => v && i !== 12).length;

            const labelCss = 'font-family: Inter, system-ui, sans-serif; font-size: 9px; font-weight: 700; color: rgba(255,255,255,0.35); text-transform: uppercase; letter-spacing: 0.08em; line-height: 1;';
            const valueCss = "font-family: 'DSEG7', Fredoka, monospace; font-size: 20px; font-weight: bold; color: #38bdf8; line-height: 1; text-shadow: 0 0 8px rgba(56,189,248,0.5), 0 0 20px rgba(56,189,248,0.2);";
            const suffixCss = 'font-family: Inter, system-ui, sans-serif; font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.25); line-height: 1; margin-left: -2px;';
            const itemCss = 'display: flex; align-items: center; gap: 6px; padding: 7px 16px;';
            const dividerCss = 'width: 1px; height: 20px; background: rgba(255,255,255,0.08); flex-shrink: 0;';

            const statsBar = document.createElement('div');
            statsBar.style.cssText = `
                display: inline-flex; align-items: center;
                background: rgba(0,0,0,0.35);
                border: 1px solid rgba(255,255,255,0.08);
                border-radius: 10px; padding: 0;
                box-shadow: inset 0 2px 6px rgba(0,0,0,0.4), inset 0 0 1px rgba(0,0,0,0.3);
            `;
            statsBar.innerHTML = `
                <div style="${itemCss}">
                    <span style="${labelCss}">Checked</span>
                    <span style="${valueCss}">${checked}</span>
                    <span style="${suffixCss}">/24</span>
                </div>
                <div style="${dividerCss}"></div>
                <div style="${itemCss}">
                    <span style="${labelCss}">Bingos</span>
                    <span style="${valueCss}">${wins}</span>
                </div>
            `;
            wrapper.appendChild(statsBar);

            // Personality title badge
            const titleBadge = document.createElement('div');
            titleBadge.style.cssText = `
                font-family: Fredoka, Inter, system-ui, sans-serif;
                font-size: 14px; font-weight: 600; color: #e2e8f0;
                background: rgba(255,255,255,0.06);
                border: 1px solid rgba(255,255,255,0.08);
                border-radius: 20px; padding: 4px 18px;
                text-align: center; letter-spacing: 0.02em;
                margin-top: -6px;
            `;
            titleBadge.textContent = getTitle(checked);
            wrapper.appendChild(titleBadge);

            const boardClone = boardEl.cloneNode(true);
            boardClone.style.background = getComputedStyle(document.body).getPropertyValue('--bg-mid').trim();
            boardClone.style.border = '1px solid rgba(255,255,255,0.10)';
            boardClone.style.maxWidth = boardEl.offsetWidth + 'px';

            const captureStyle = document.createElement('style');
            captureStyle.textContent = `.grid-cell::before, .grid-cell::after { display: none !important; }`;
            boardClone.prepend(captureStyle);

            // Read CSS variables once for theme-aware capture
            const cs = getComputedStyle(document.body);
            const cFrom = cs.getPropertyValue('--checked-from').trim();
            const cMid = cs.getPropertyValue('--checked-mid').trim();
            const cTo = cs.getPropertyValue('--checked-to').trim();
            const cSpanFrom = cs.getPropertyValue('--checked-span-from').trim();
            const cSpanTo = cs.getPropertyValue('--checked-span-to').trim();
            const cEdge = cs.getPropertyValue('--checked-edge').trim();
            const tFrom = cs.getPropertyValue('--tile-from').trim();
            const tMid = cs.getPropertyValue('--tile-mid').trim();
            const tTo = cs.getPropertyValue('--tile-to').trim();
            const tEdge = cs.getPropertyValue('--ice-edge').trim();

            boardClone.querySelectorAll('.grid-cell').forEach(cell => {
                const input = cell.querySelector('input');
                const isChecked = input && input.checked;
                const span = cell.querySelector('span');

                cell.style.backdropFilter = 'none';
                cell.style.webkitBackdropFilter = 'none';

                if (cell.classList.contains('center-cell')) return;

                if (isChecked) {
                    cell.style.background = `linear-gradient(155deg, ${cFrom} 0%, ${cMid} 50%, ${cTo} 100%)`;
                    cell.style.boxShadow = `0 4px 0 ${cEdge}, 0 6px 14px rgba(0,0,0,0.3)`;
                    if (span) {
                        span.style.background = `linear-gradient(135deg, ${cSpanFrom} 0%, ${cSpanTo} 100%)`;
                        span.style.borderRadius = '9px';
                    }
                } else {
                    cell.style.background = `linear-gradient(155deg, ${tFrom} 0%, ${tMid} 60%, ${tTo} 100%)`;
                    cell.style.boxShadow = `0 4px 0 ${tEdge}, 0 6px 14px rgba(0,0,0,0.25)`;
                    if (span) {
                        span.style.background = 'transparent';
                        span.style.boxShadow = 'none';
                    }
                }
            });

            wrapper.appendChild(boardClone);

            const cta = document.createElement('div');
            cta.style.cssText = `
                text-align: center; padding-top: 4px;
            `;
            cta.innerHTML = `
                <span style="font-family: Inter, system-ui, sans-serif; font-size: 13px; font-weight: 500; color: #64748b;">Play yours at </span><span style="font-family: Fredoka, Inter, system-ui, sans-serif; font-size: 16px; font-weight: 700; color: #e2e8f0;">icebreakerbingo.com</span>
            `;
            wrapper.appendChild(cta);

            document.body.appendChild(wrapper);

            try {
                const canvas = await html2canvas(wrapper, {
                    backgroundColor: bgDeep,
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                document.body.removeChild(wrapper);
                return await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            } catch (err) {
                if (document.body.contains(wrapper)) document.body.removeChild(wrapper);
                console.error('Image generation failed:', err);
                return null;
            }
        }

        async function shareBoard() {
            // Brief loading state on share buttons
            const shareBtns = document.querySelectorAll('#shareBtn, #overlayShareBtn');
            shareBtns.forEach(btn => { btn.disabled = true; btn.style.opacity = '0.6'; });

            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

            const blob = await generateBoardImage();
            shareBtns.forEach(btn => { btn.disabled = false; btn.style.opacity = ''; });
            if (!blob) {
                showToast('\u26A0\uFE0F', 'Could not generate image');
                return;
            }

            currentImageBlob = blob;

            if (isMobile && navigator.canShare) {
                // Mobile: use native share API which attaches the image directly
                try {
                    const file = new File([blob], 'icebreaker-bingo.png', { type: 'image/png' });
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: 'Icebreaker Bingo',
                            text: getShareText()
                        });
                        return;
                    }
                } catch (err) {
                    if (err.name === 'AbortError') return;
                    // Fall through to share panel on failure
                }
            }

            // Desktop (or mobile fallback): copy to clipboard + show share panel
            // Show/hide native share button based on browser support
            const nativeShareBtn = document.getElementById('shareNativeBtn');
            if (nativeShareBtn) {
                const file = new File([blob], 'icebreaker-bingo.png', { type: 'image/png' });
                const canNativeShare = navigator.canShare && navigator.canShare({ files: [file] });
                nativeShareBtn.style.display = canNativeShare ? '' : 'none';
            }

            const copied = await copyImageToClipboard(blob);
            const hint = document.getElementById('sharePanelHint');
            if (copied) {
                setHintWave(hint, '\u2713 Image copied to clipboard \u2014 paste it in your post!');
                hint.classList.add('has-image');
            } else {
                hint.textContent = 'Use the buttons below to share or download your board.';
                hint.classList.remove('has-image');
            }
            openSharePanel();
        }

        // Platform share handlers
        const platformNames = {
            x: 'X', threads: 'Threads', facebook: 'Facebook',
            instagram: 'Instagram', whatsapp: 'WhatsApp',
            linkedin: 'LinkedIn', email: 'Email'
        };

        function openPlatformShare(platform) {
            const shareText = getShareText();
            const shareUrl = getBoardUrl();
            const encodedText = encodeURIComponent(shareText);
            const encodedUrl = encodeURIComponent(shareUrl);

            const urls = {
                x: `https://x.com/intent/post?text=${encodedText}&url=${encodedUrl}`,
                threads: `https://www.threads.net/intent/post?text=${encodedText}%20${encodedUrl}`,
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}&quote=${encodedText}`,
                instagram: 'https://www.instagram.com',
                whatsapp: `https://wa.me/?text=${encodedText}%20${encodedUrl}`,
                linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(SHARE_URL)}`,
                email: `mailto:?subject=${encodeURIComponent('Icebreaker Bingo')}&body=${encodedText}%0A%0A${encodedUrl}`
            };

            const url = urls[platform];
            if (!url) return;

            if (platform === 'email') {
                window.location.href = url;
                return;
            }

            // Auto-download image for platforms that need manual upload
            const isUploadFlow = platform === 'instagram';
            if (isUploadFlow && currentImageBlob) {
                downloadImage(currentImageBlob);
            }

            // Size popup responsively and position to the right side of the screen
            const screenW = window.screen.availWidth || window.screen.width;
            const screenH = window.screen.availHeight || window.screen.height;
            const popupW = Math.min(600, Math.round(screenW * 0.45));
            const popupH = Math.min(550, Math.round(screenH * 0.8));
            const popupMargin = 20;
            const left = Math.max(0, screenW - popupW - popupMargin);
            const top = Math.max(0, Math.round((screenH - popupH) / 2));
            const visibleGap = left;

            // Close all overlays, then show paste coach in the visible gap
            closeSharePanel();
            closeOverlay();
            showPasteCoach(platform, visibleGap);

            window.open(url, '_blank', `width=${popupW},height=${popupH},left=${left},top=${top},noreferrer`);
        }

        // Paste coach
        let pasteCoachActive = false;
        let pasteCoachRevealTimer = null;
        const PASTE_COACH_REVEAL_DELAY = 2500;

        function onWindowFocus() {
            if (pasteCoachActive) dismissPasteCoach();
        }

        function showPasteCoach(platform, visibleGap) {
            const coach = document.getElementById('pasteCoach');
            const loadingEl = document.getElementById('pasteCoachLoading');
            const pasteMode = document.getElementById('pasteCoachPasteMode');
            const uploadMode = document.getElementById('pasteCoachUploadMode');
            const linkMode = document.getElementById('pasteCoachLinkMode');
            const allModes = [pasteMode, uploadMode, linkMode];
            const isMac = /Mac|iPhone|iPad|iPod/i.test(navigator.platform || navigator.userAgent);

            // Determine which instruction mode to show
            let revealMode;
            if (platform === 'instagram') {
                revealMode = uploadMode;
            } else if (platform === 'linkedin') {
                revealMode = linkMode;
            } else {
                revealMode = pasteMode;
            }

            // Position card: center in the visible gap if wide enough,
            // otherwise center in the full viewport
            const cardW = 360;
            const minGap = cardW + 40;
            if (visibleGap && visibleGap >= minGap) {
                const offset = Math.round((visibleGap - cardW) / 2);
                coach.style.setProperty('--coach-offset', `${offset}px`);
                coach.style.setProperty('--coach-mr', '0');
            } else {
                coach.style.setProperty('--coach-offset', 'auto');
                coach.style.setProperty('--coach-mr', 'auto');
            }

            // Populate text content
            const name = platformNames[platform] || platform;
            document.getElementById('pasteCoachPlatform').textContent =
                `To share your board to ${name}`;
            document.getElementById('pasteCoachLoadingName').textContent = name;

            if (revealMode === pasteMode) {
                document.getElementById('pasteCoachModKey').innerHTML = isMac ? '&#8984;' : 'Ctrl';
                const targetWord = (platform === 'x' || platform === 'threads' ||
                    platform === 'facebook') ? 'post' : 'message';
                document.getElementById('pasteCoachTarget').textContent = targetWord;
            }

            // Reset phases: show loading, hide all instruction modes
            loadingEl.classList.remove('fade-out');
            loadingEl.style.display = '';
            allModes.forEach(m => { m.classList.remove('fade-in'); m.style.display = 'none'; });

            coach.classList.add('active');
            pasteCoachActive = true;

            // After delay, crossfade from loading to the appropriate instructions
            clearTimeout(pasteCoachRevealTimer);
            pasteCoachRevealTimer = setTimeout(() => {
                loadingEl.classList.add('fade-out');

                revealMode.style.display = '';
                revealMode.offsetHeight; // trigger reflow
                revealMode.classList.add('fade-in');

                setTimeout(() => { loadingEl.style.display = 'none'; }, 400);
            }, PASTE_COACH_REVEAL_DELAY);

            // Dismiss when user returns to this window (after closing/leaving the popup)
            window.addEventListener('focus', onWindowFocus);
        }

        function dismissPasteCoach() {
            pasteCoachActive = false;
            clearTimeout(pasteCoachRevealTimer);
            document.getElementById('pasteCoach').classList.remove('active');
            window.removeEventListener('focus', onWindowFocus);
        }

        document.getElementById('pasteCoachDismiss').addEventListener('click', dismissPasteCoach);
        document.getElementById('pasteCoach').addEventListener('click', (e) => {
            if (e.target.id === 'pasteCoach') dismissPasteCoach();
        });

        // Share panel event listeners
        document.getElementById('sharePanelClose').addEventListener('click', closeSharePanel);

        document.getElementById('shareOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'shareOverlay') closeSharePanel();
        });

        document.querySelectorAll('.platform-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                openPlatformShare(btn.dataset.platform);
            });
        });

        document.getElementById('shareNativeBtn').addEventListener('click', async () => {
            if (!currentImageBlob) return;
            try {
                const file = new File([currentImageBlob], 'icebreaker-bingo.png', { type: 'image/png' });
                await navigator.share({
                    files: [file],
                    title: 'Icebreaker Bingo',
                    text: getShareText()
                });
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showToast('\u26A0\uFE0F', 'Native share failed — try another option');
                }
            }
        });

        document.getElementById('shareCopyBtn').addEventListener('click', async () => {
            if (!currentImageBlob) return;
            const copied = await copyImageToClipboard(currentImageBlob);
            if (copied) {
                showToast('\u2705', 'Image copied to clipboard!');
            } else {
                showToast('\u26A0\uFE0F', 'Copy failed — try downloading instead');
            }
        });

        document.getElementById('shareDownloadBtn').addEventListener('click', () => {
            if (!currentImageBlob) return;
            downloadImage(currentImageBlob);
            showToast('\u2B07\uFE0F', 'Image downloaded!');
        });

        document.getElementById('shareLinkBtn').addEventListener('click', async () => {
            const url = getBoardUrl();
            try {
                await navigator.clipboard.writeText(url);
                showToast('\uD83D\uDD17', 'Challenge link copied!');
            } catch (e) {
                // Fallback
                const ta = document.createElement('textarea');
                ta.value = url;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('\uD83D\uDD17', 'Challenge link copied!');
            }
        });

        // Focus trap inside share panel (WCAG 2.4.3)
        document.getElementById('shareOverlay').addEventListener('keydown', (e) => {
            if (e.key !== 'Tab') return;
            const panel = document.querySelector('.share-panel');
            const focusable = panel.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (focusable.length === 0) return;

            const first = focusable[0];
            const last = focusable[focusable.length - 1];

            if (e.shiftKey) {
                if (document.activeElement === first) { e.preventDefault(); last.focus(); }
            } else {
                if (document.activeElement === last) { e.preventDefault(); first.focus(); }
            }
        });

        // ─── Initialization ───
        buildThemePicker();
        applyVisualTheme(currentTheme);

        const DEFAULT_SUBTITLE = 'Check every square that sounds like you, then share it!';

        // Check for challenge link in URL
        const fromUrl = loadFromUrl();
        if (!fromUrl) {
            initBoard();
            if (isDailyMode) loadDailyProgress();
        } else {
            initBoard();
        }

        // Pre-fill sharer's cells if arriving from a challenge link
        if (window._challengerCells) {
            for (let i = 0; i < 25; i++) {
                cells[i] = window._challengerCells[i];
            }
            cells[12] = true; // free space always checked
        }

        createGrid();
        document.getElementById('winsCount').textContent = wins;
        suppressTitleToast = false;

        // Activate challenge viewer mode if challenger data exists
        if (window._challengerCells) {
            const mainEl = document.getElementById('bingo-game');
            mainEl.classList.add('challenge-viewer');

            // Calculate sharer's stats
            const challengerChecked = window._challengerCells.filter((v, i) => v && i !== 12).length;
            const challengerTitle = getTitle(challengerChecked);

            // Update header subtitle
            const headerSubtitle = document.querySelector('.header p');
            headerSubtitle.textContent = '';
            headerSubtitle.innerHTML = `Your friend is a <strong>${challengerTitle}</strong>! They checked <strong>${challengerChecked}/24</strong> squares.`;

            // Show challenge banner with CTA
            const banner = document.getElementById('challengeBanner');
            document.getElementById('challengeMessage').innerHTML =
                'Think you can do better? Start your own board!';
            document.getElementById('challengeCta').addEventListener('click', startOwnBoard);
        }
    </script>
</body>
</html>
